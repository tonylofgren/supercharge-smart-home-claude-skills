# Generated by esphome@aurora-smart-home v1.0.0
# https://github.com/tonylofgren/aurora-smart-home
#
# Battery-Powered Sensor Template
# Deep sleep with battery monitoring

substitutions:
  device_name: "battery-sensor"
  friendly_name: "Battery Sensor"
  sleep_duration: "5min"
  run_duration: "30s"

esphome:
  name: ${device_name}
  friendly_name: ${friendly_name}
  on_boot:
    priority: 600
    then:
      - lambda: |-
          switch(esp_sleep_get_wakeup_cause()) {
            case ESP_SLEEP_WAKEUP_TIMER:
              id(wakeup_reason).publish_state("Timer");
              break;
            case ESP_SLEEP_WAKEUP_EXT0:
              id(wakeup_reason).publish_state("GPIO");
              break;
            default:
              id(wakeup_reason).publish_state("Power On");
          }

esp32:
  board: esp32dev

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  fast_connect: true
  power_save_mode: light

api:
  encryption:
    key: !secret api_encryption_key

ota:
  platform: esphome
  on_begin:
    - deep_sleep.prevent: deep_sleep_1
  on_end:
    - deep_sleep.allow: deep_sleep_1
  on_error:
    - deep_sleep.allow: deep_sleep_1

logger:
  level: WARN
  baud_rate: 0  # Disable serial logging to save power

deep_sleep:
  id: deep_sleep_1
  run_duration: ${run_duration}
  sleep_duration: ${sleep_duration}
  # Uncomment for GPIO wakeup:
  # wakeup_pin: GPIO33
  # wakeup_pin_mode: INVERT_WAKEUP

sensor:
  # Battery voltage (via voltage divider)
  - platform: adc
    pin: GPIO34
    name: "${friendly_name} Battery Voltage"
    id: battery_voltage
    attenuation: 11db
    update_interval: 10s
    filters:
      - multiply: 2  # Adjust for your voltage divider ratio
    unit_of_measurement: "V"
    accuracy_decimals: 2
    on_value_range:
      - below: 3.2
        then:
          - logger.log: "Battery critical - extending sleep"
          - deep_sleep.enter:
              id: deep_sleep_1
              sleep_duration: 1h

  # Battery percentage
  - platform: template
    name: "${friendly_name} Battery"
    unit_of_measurement: "%"
    device_class: battery
    accuracy_decimals: 0
    lambda: |-
      float voltage = id(battery_voltage).state;
      float percentage = (voltage - 3.0) / (4.2 - 3.0) * 100;
      if (percentage > 100) return 100;
      if (percentage < 0) return 0;
      return percentage;
    update_interval: 10s

  # DHT22 Temperature/Humidity
  - platform: dht
    pin: GPIO4
    model: DHT22
    update_interval: 10s
    temperature:
      name: "${friendly_name} Temperature"
    humidity:
      name: "${friendly_name} Humidity"

binary_sensor:
  # Low battery warning
  - platform: template
    name: "${friendly_name} Low Battery"
    device_class: battery
    lambda: return id(battery_voltage).state < 3.4;

  # Button to keep awake (for OTA)
  - platform: gpio
    pin:
      number: GPIO0
      mode: INPUT_PULLUP
    name: "${friendly_name} OTA Mode"
    on_press:
      - deep_sleep.prevent: deep_sleep_1
      - logger.log: "OTA mode - sleep prevented"

text_sensor:
  - platform: template
    name: "${friendly_name} Wakeup Reason"
    id: wakeup_reason
    update_interval: never
