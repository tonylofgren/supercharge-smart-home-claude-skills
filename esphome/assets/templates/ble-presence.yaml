# Generated by esphome@aurora-smart-home v1.0.0
# https://github.com/tonylofgren/aurora-smart-home
#
# BLE Presence Detection Template
# Track phones and Bluetooth devices

substitutions:
  device_name: "ble-presence"
  friendly_name: "BLE Presence"
  # Add MAC addresses of devices to track
  phone_1_mac: "AA:BB:CC:DD:EE:FF"
  phone_2_mac: "11:22:33:44:55:66"

esphome:
  name: ${device_name}
  friendly_name: ${friendly_name}

esp32:
  board: esp32dev

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  ap:
    ssid: "${device_name}-fallback"
    password: !secret wifi_ap_password

captive_portal:

api:
  encryption:
    key: !secret api_encryption_key

ota:
  platform: esphome
  password: !secret ota_password

logger:

# BLE Tracker
esp32_ble_tracker:
  scan_parameters:
    interval: 1100ms
    window: 1100ms
    active: true
    continuous: true

# Bluetooth Proxy for Home Assistant
bluetooth_proxy:
  active: true

binary_sensor:
  # Phone 1 presence
  - platform: ble_presence
    mac_address: ${phone_1_mac}
    name: "Person 1 Present"
    id: person1
    device_class: presence
    filters:
      - delayed_off: 5min

  # Phone 2 presence
  - platform: ble_presence
    mac_address: ${phone_2_mac}
    name: "Person 2 Present"
    id: person2
    device_class: presence
    filters:
      - delayed_off: 5min

  # Combined occupancy
  - platform: template
    name: "${friendly_name} Room Occupied"
    device_class: occupancy
    lambda: return id(person1).state || id(person2).state;
    on_press:
      - homeassistant.event:
          event: esphome.room_occupied
          data:
            room: "${device_name}"
    on_release:
      - homeassistant.event:
          event: esphome.room_empty
          data:
            room: "${device_name}"

  - platform: status
    name: "${friendly_name} Status"

sensor:
  # Signal strength for Person 1
  - platform: ble_rssi
    mac_address: ${phone_1_mac}
    name: "Person 1 RSSI"
    filters:
      - sliding_window_moving_average:
          window_size: 5
          send_every: 1

  # Signal strength for Person 2
  - platform: ble_rssi
    mac_address: ${phone_2_mac}
    name: "Person 2 RSSI"
    filters:
      - sliding_window_moving_average:
          window_size: 5
          send_every: 1

  - platform: wifi_signal
    name: "${friendly_name} WiFi Signal"
    update_interval: 60s

  - platform: uptime
    name: "${friendly_name} Uptime"

text_sensor:
  - platform: wifi_info
    ip_address:
      name: "${friendly_name} IP"

button:
  - platform: restart
    name: "${friendly_name} Restart"

# Optional: iBeacon detection
# binary_sensor:
#   - platform: ble_presence
#     ibeacon_uuid: "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
#     ibeacon_major: 1
#     ibeacon_minor: 1
#     name: "iBeacon Present"
