# Generated by esphome@aurora-smart-home v1.0.0
# https://github.com/tonylofgren/aurora-smart-home
#
# ESPHome Template - Garage Door Controller
# With endstop sensors and safety obstruction detection

substitutions:
  device_name: "garage-door"
  friendly_name: "Garage Door"

esphome:
  name: ${device_name}
  friendly_name: ${friendly_name}

esp8266:
  board: d1_mini

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  ap:
    ssid: "${device_name}-fallback"

captive_portal:

api:
  encryption:
    key: !secret api_encryption_key

ota:
  - platform: esphome
    password: !secret ota_password

logger:

# ===== SENSORS =====

binary_sensor:
  # Closed endstop (magnetic reed switch)
  - platform: gpio
    pin:
      number: GPIO5
      mode: INPUT_PULLUP
      inverted: true
    id: door_closed
    name: "Door Closed"
    device_class: garage_door
    filters:
      - delayed_on: 100ms

  # Open endstop (magnetic reed switch)
  - platform: gpio
    pin:
      number: GPIO4
      mode: INPUT_PULLUP
      inverted: true
    id: door_open
    name: "Door Open"
    filters:
      - delayed_on: 100ms

  # Obstruction sensor (IR beam or similar)
  - platform: gpio
    pin:
      number: GPIO14
      mode: INPUT_PULLUP
    id: obstruction
    name: "Obstruction"
    device_class: safety
    on_press:
      # Stop door if moving
      - if:
          condition:
            lambda: |-
              auto call = id(garage_door).make_call();
              return call.get_position().has_value();
          then:
            - cover.stop: garage_door
            - homeassistant.service:
                service: notify.mobile_app
                data:
                  title: "Garage Door Alert"
                  message: "Obstruction detected!"

  # Wall button (optional)
  - platform: gpio
    pin:
      number: GPIO12
      mode: INPUT_PULLUP
      inverted: true
    name: "Wall Button"
    on_click:
      - cover.toggle: garage_door

  - platform: status
    name: "Status"

# ===== RELAY =====

switch:
  - platform: gpio
    id: relay
    pin: GPIO13
    restore_mode: ALWAYS_OFF
    # Pulse relay for 500ms (simulates button press)
    on_turn_on:
      - delay: 500ms
      - switch.turn_off: relay

# ===== COVER =====

cover:
  - platform: template
    id: garage_door
    name: "Garage Door"
    device_class: garage

    # Current state
    lambda: |-
      if (id(door_closed).state) {
        return COVER_CLOSED;
      } else if (id(door_open).state) {
        return COVER_OPEN;
      } else {
        return {};  // Moving or unknown
      }

    # Open action
    open_action:
      - if:
          condition:
            binary_sensor.is_on: door_closed
          then:
            - switch.turn_on: relay

    # Close action (with safety check)
    close_action:
      - if:
          condition:
            and:
              - binary_sensor.is_on: door_open
              - binary_sensor.is_off: obstruction
          then:
            - switch.turn_on: relay
          else:
            - if:
                condition:
                  binary_sensor.is_on: obstruction
                then:
                  - logger.log: "Cannot close - obstruction detected"

    # Stop action
    stop_action:
      - switch.turn_on: relay

# ===== DIAGNOSTICS =====

sensor:
  - platform: wifi_signal
    name: "WiFi Signal"
    update_interval: 60s
    entity_category: diagnostic

  - platform: uptime
    name: "Uptime"
    entity_category: diagnostic

text_sensor:
  - platform: version
    name: "ESPHome Version"
    entity_category: diagnostic

button:
  - platform: restart
    name: "Restart"
    entity_category: config

# Status LED
status_led:
  pin:
    number: GPIO2
    inverted: true
