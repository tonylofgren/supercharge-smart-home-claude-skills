# Generated by esphome@aurora-smart-home v1.0.0
# https://github.com/tonylofgren/aurora-smart-home
#
# ESPHome Template - LED Matrix Clock
# MAX7219 4-module 8x32 LED matrix display

substitutions:
  device_name: "led-clock"
  friendly_name: "LED Clock"

esphome:
  name: ${device_name}
  friendly_name: ${friendly_name}

esp8266:
  board: d1_mini

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  ap:
    ssid: "${device_name}-fallback"

captive_portal:

api:
  encryption:
    key: !secret api_encryption_key

ota:
  - platform: esphome
    password: !secret ota_password

logger:

# SPI for MAX7219
spi:
  clk_pin: GPIO14   # D5
  mosi_pin: GPIO13  # D7

# Time from Home Assistant
time:
  - platform: homeassistant
    id: ha_time

# Font for display
font:
  - file: "gfonts://Roboto"
    id: digit_font
    size: 8

# Display modes
globals:
  - id: display_mode
    type: int
    initial_value: "0"
  - id: scroll_message
    type: std::string
    initial_value: '""'

# Button to cycle modes
binary_sensor:
  - platform: gpio
    pin:
      number: GPIO0
      mode: INPUT_PULLUP
      inverted: true
    name: "Mode Button"
    on_click:
      - lambda: |-
          id(display_mode) = (id(display_mode) + 1) % 4;

  - platform: status
    name: "Status"

# Brightness control
number:
  - platform: template
    name: "Brightness"
    id: brightness
    min_value: 0
    max_value: 15
    step: 1
    initial_value: 8
    optimistic: true
    set_action:
      - lambda: |-
          id(led_matrix).set_intensity(x);

# Optional temperature sensor
sensor:
  - platform: homeassistant
    entity_id: sensor.outside_temperature
    id: outside_temp
    internal: true

  - platform: wifi_signal
    name: "WiFi Signal"
    update_interval: 60s
    entity_category: diagnostic

# Text input for custom message
text_sensor:
  - platform: homeassistant
    entity_id: input_text.led_message
    id: custom_message
    on_value:
      - lambda: |-
          id(scroll_message) = x;

  - platform: version
    name: "ESPHome Version"
    entity_category: diagnostic

# LED Matrix Display
display:
  - platform: max7219digit
    id: led_matrix
    cs_pin: GPIO15  # D8
    num_chips: 4
    intensity: 8
    rotate_chip: 0
    scroll_enable: false
    scroll_speed: 100ms

    lambda: |-
      switch (id(display_mode)) {
        case 0:
          // Clock HH:MM
          if (id(ha_time).now().is_valid()) {
            it.strftime(0, 0, id(digit_font), "%H:%M", id(ha_time).now());
          } else {
            it.print(0, 0, id(digit_font), "--:--");
          }
          break;

        case 1:
          // Clock HH:MM:SS
          if (id(ha_time).now().is_valid()) {
            it.strftime(0, 0, id(digit_font), "%H%M%S", id(ha_time).now());
          }
          break;

        case 2:
          // Date
          if (id(ha_time).now().is_valid()) {
            it.strftime(0, 0, id(digit_font), "%d.%m", id(ha_time).now());
          }
          break;

        case 3:
          // Temperature (if available)
          if (!isnan(id(outside_temp).state)) {
            it.printf(0, 0, id(digit_font), "%.0fC", id(outside_temp).state);
          } else {
            it.print(0, 0, id(digit_font), "-- C");
          }
          break;
      }

# Cycle through modes automatically
interval:
  - interval: 10s
    then:
      - lambda: |-
          // Auto-cycle through time and date
          if (id(display_mode) < 2) {
            id(display_mode) = (id(display_mode) + 1) % 2;
          }

button:
  - platform: restart
    name: "Restart"
    entity_category: config

# ===== SCROLLING MESSAGE DISPLAY =====
# Uncomment to enable scrolling text

# display:
#   - platform: max7219digit
#     cs_pin: GPIO15
#     num_chips: 4
#     intensity: 8
#     scroll_enable: true
#     scroll_mode: CONTINUOUS
#     scroll_speed: 100ms
#     scroll_delay: 2
#     lambda: |-
#       if (!id(scroll_message).empty()) {
#         it.print(0, 0, id(digit_font), id(scroll_message).c_str());
#       } else {
#         it.strftime(0, 0, id(digit_font), "%H:%M", id(ha_time).now());
#       }
