# Generated by esphome@aurora-smart-home v1.0.0
# https://github.com/tonylofgren/aurora-smart-home
#
# ESPHome Template - Shelly 1PM
# Power monitoring relay with button input

substitutions:
  device_name: "shelly-1pm"
  friendly_name: "Shelly 1PM"

esphome:
  name: ${device_name}
  friendly_name: ${friendly_name}

esp8266:
  board: esp01_1m

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  ap:
    ssid: "${device_name}-fallback"

captive_portal:

api:
  encryption:
    key: !secret api_encryption_key

ota:
  - platform: esphome
    password: !secret ota_password

logger:
  baud_rate: 0  # Disable UART logging (used for power monitoring)

# Physical button input
binary_sensor:
  - platform: gpio
    pin:
      number: GPIO4
      mode: INPUT_PULLUP
    name: "Switch"
    on_press:
      - switch.toggle: relay
    filters:
      - delayed_on: 10ms

  - platform: status
    name: "Status"

# Main relay
switch:
  - platform: gpio
    id: relay
    name: "Relay"
    pin: GPIO15
    restore_mode: RESTORE_DEFAULT_OFF

# Power monitoring (HLW8012 chip)
sensor:
  - platform: hlw8012
    sel_pin: GPIO12
    cf_pin: GPIO5
    cf1_pin: GPIO14
    current_resistor: 0.001 ohm
    voltage_divider: 1925
    change_mode_every: 1
    update_interval: 5s

    current:
      name: "Current"
      unit_of_measurement: A
      accuracy_decimals: 3
      filters:
        - throttle_average: 10s

    voltage:
      name: "Voltage"
      unit_of_measurement: V
      accuracy_decimals: 1
      filters:
        - throttle_average: 10s

    power:
      name: "Power"
      unit_of_measurement: W
      accuracy_decimals: 1
      filters:
        - throttle_average: 10s

    energy:
      name: "Energy"
      unit_of_measurement: kWh
      accuracy_decimals: 3
      filters:
        - multiply: 0.001

  - platform: wifi_signal
    name: "WiFi Signal"
    update_interval: 60s
    entity_category: diagnostic

  - platform: uptime
    name: "Uptime"
    entity_category: diagnostic

text_sensor:
  - platform: version
    name: "ESPHome Version"
    entity_category: diagnostic

button:
  - platform: restart
    name: "Restart"
    entity_category: config

# Blue status LED
status_led:
  pin:
    number: GPIO0
    inverted: true
