# Generated by esphome@aurora-smart-home v1.0.0
# https://github.com/tonylofgren/aurora-smart-home
#
# ESPHome Template - Smart Thermostat
# Temperature-controlled relay with PID or bang-bang

substitutions:
  device_name: "thermostat"
  friendly_name: "Smart Thermostat"

esphome:
  name: ${device_name}
  friendly_name: ${friendly_name}

esp32:
  board: esp32dev

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  ap:
    ssid: "${device_name}-fallback"

captive_portal:

api:
  encryption:
    key: !secret api_encryption_key

ota:
  - platform: esphome
    password: !secret ota_password

logger:

i2c:
  sda: GPIO21
  scl: GPIO22
  scan: true

# Temperature sensor (BME280)
sensor:
  - platform: bme280_i2c
    address: 0x76
    update_interval: 30s
    temperature:
      id: room_temp
      name: "Room Temperature"
    humidity:
      id: room_humidity
      name: "Room Humidity"

  - platform: wifi_signal
    name: "WiFi Signal"
    update_interval: 60s
    entity_category: diagnostic

  - platform: uptime
    name: "Uptime"
    entity_category: diagnostic

# Heating relay
switch:
  - platform: gpio
    id: heater_relay
    name: "Heater Relay"
    pin: GPIO5
    restore_mode: ALWAYS_OFF

# ===== OPTION 1: Simple Thermostat (Bang-Bang) =====
climate:
  - platform: thermostat
    name: "Thermostat"
    sensor: room_temp

    # Timing protection
    min_heating_off_time: 5min
    min_heating_run_time: 5min
    min_idle_time: 1min

    # Actions
    heat_action:
      - switch.turn_on: heater_relay
    idle_action:
      - switch.turn_off: heater_relay

    # Hysteresis
    heat_deadband: 0.5  # Start heating at setpoint - 0.5
    heat_overrun: 0.5   # Stop heating at setpoint + 0.5

    # Presets
    default_preset: Home
    preset:
      - name: Home
        default_target_temperature_low: 21
      - name: Away
        default_target_temperature_low: 16
      - name: Sleep
        default_target_temperature_low: 18
      - name: Boost
        default_target_temperature_low: 24

# ===== OPTION 2: PID Controller (Uncomment to use) =====
# Requires slow_pwm output for modulating heat

# output:
#   - platform: slow_pwm
#     id: heater_pwm
#     pin: GPIO5
#     period: 30s

# climate:
#   - platform: pid
#     name: "PID Thermostat"
#     sensor: room_temp
#     default_target_temperature: 21
#     heat_output: heater_pwm
#
#     control_parameters:
#       kp: 0.5
#       ki: 0.02
#       kd: 0.1
#
#     deadband_parameters:
#       threshold_high: 0.5
#       threshold_low: -0.5

# ===== Physical Controls =====
binary_sensor:
  - platform: gpio
    pin:
      number: GPIO12
      mode: INPUT_PULLUP
      inverted: true
    name: "Temp Up Button"
    on_click:
      - climate.control:
          id: thermostat
          target_temperature: !lambda |-
            return id(thermostat).target_temperature + 0.5;

  - platform: gpio
    pin:
      number: GPIO14
      mode: INPUT_PULLUP
      inverted: true
    name: "Temp Down Button"
    on_click:
      - climate.control:
          id: thermostat
          target_temperature: !lambda |-
            return id(thermostat).target_temperature - 0.5;

  - platform: status
    name: "Status"

# Status LED
output:
  - platform: ledc
    id: status_led
    pin: GPIO2

light:
  - platform: monochromatic
    id: led
    output: status_led
    name: "Status LED"

# LED indicates heating state
interval:
  - interval: 1s
    then:
      - if:
          condition:
            switch.is_on: heater_relay
          then:
            - light.turn_on:
                id: led
                brightness: 100%
          else:
            - light.turn_on:
                id: led
                brightness: 10%

text_sensor:
  - platform: version
    name: "ESPHome Version"
    entity_category: diagnostic

button:
  - platform: restart
    name: "Restart"
    entity_category: config
