# Generated by esphome@aurora-smart-home v1.0.0
# https://github.com/tonylofgren/aurora-smart-home
#
# Touch Panel Template
# ESP32 touch buttons with OLED display

substitutions:
  device_name: "touch-panel"
  friendly_name: "Touch Panel"

esphome:
  name: ${device_name}
  friendly_name: ${friendly_name}

esp32:
  board: esp32dev

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  ap:
    ssid: "${device_name}-fallback"
    password: !secret wifi_ap_password

captive_portal:

api:
  encryption:
    key: !secret api_encryption_key

ota:
  platform: esphome
  password: !secret ota_password

logger:

i2c:
  sda: GPIO21
  scl: GPIO22
  scan: true

# ESP32 Touch Configuration
esp32_touch:
  setup_mode: false  # Set to true to calibrate thresholds

binary_sensor:
  # Touch Button 1
  - platform: esp32_touch
    pin: GPIO4
    name: "${friendly_name} Button 1"
    threshold: 1000
    on_press:
      - homeassistant.service:
          service: light.toggle
          data:
            entity_id: light.living_room
      - script.execute: beep

  # Touch Button 2
  - platform: esp32_touch
    pin: GPIO15
    name: "${friendly_name} Button 2"
    threshold: 1000
    on_press:
      - homeassistant.service:
          service: light.toggle
          data:
            entity_id: light.bedroom
      - script.execute: beep

  # Touch Button 3
  - platform: esp32_touch
    pin: GPIO13
    name: "${friendly_name} Button 3"
    threshold: 1000
    on_press:
      - homeassistant.service:
          service: switch.toggle
          data:
            entity_id: switch.fan
      - script.execute: beep

  # Touch Button 4 (GPIO12 is a strapping pin - use with caution)
  - platform: esp32_touch
    pin: GPIO12
    name: "${friendly_name} Button 4"
    threshold: 1000
    on_multi_click:
      - timing:
          - ON for at most 500ms
          - OFF for at least 50ms
        then:
          - display.page.show_next: oled
          - component.update: oled
          - script.execute: beep
      - timing:
          - ON for 1s to 5s
          - OFF for at least 50ms
        then:
          - button.press: restart_btn
          - script.execute: long_beep

  - platform: status
    name: "${friendly_name} Status"

# Buzzer output
output:
  - platform: ledc
    pin: GPIO25
    id: buzzer

# Buzzer scripts
script:
  - id: beep
    then:
      - output.turn_on: buzzer
      - output.ledc.set_frequency:
          id: buzzer
          frequency: 2000Hz
      - output.set_level:
          id: buzzer
          level: 50%
      - delay: 50ms
      - output.turn_off: buzzer

  - id: long_beep
    then:
      - output.turn_on: buzzer
      - output.ledc.set_frequency:
          id: buzzer
          frequency: 1000Hz
      - output.set_level:
          id: buzzer
          level: 50%
      - delay: 500ms
      - output.turn_off: buzzer

# OLED Display
font:
  - file: "gfonts://Roboto"
    id: font_large
    size: 20
  - file: "gfonts://Roboto"
    id: font_small
    size: 12

display:
  - platform: ssd1306_i2c
    model: "SSD1306 128x64"
    id: oled
    pages:
      - id: page_main
        lambda: |-
          it.print(0, 0, id(font_large), "Touch Panel");
          it.print(0, 25, id(font_small), "1: Living Room");
          it.print(0, 37, id(font_small), "2: Bedroom");
          it.print(0, 49, id(font_small), "3: Fan | 4: Menu");

      - id: page_status
        lambda: |-
          it.print(0, 0, id(font_large), "Status");
          it.printf(0, 25, id(font_small), "WiFi: %.0f dBm", id(wifi_rssi).state);
          it.printf(0, 37, id(font_small), "Uptime: %.0f min", id(uptime_sensor).state / 60);
          it.printf(0, 49, id(font_small), "IP: %s", id(ip_address).state.c_str());

      - id: page_info
        lambda: |-
          it.print(0, 0, id(font_large), "Touch Panel");
          it.print(0, 25, id(font_small), "v2.2.0");
          it.print(0, 37, id(font_small), "ESPHome");
          it.print(0, 49, id(font_small), "Hold 4 to restart");

# Auto-rotate pages
interval:
  - interval: 10s
    then:
      - display.page.show_next: oled
      - component.update: oled

sensor:
  - platform: wifi_signal
    name: "${friendly_name} WiFi Signal"
    id: wifi_rssi
    update_interval: 60s

  - platform: uptime
    name: "${friendly_name} Uptime"
    id: uptime_sensor

text_sensor:
  - platform: wifi_info
    ip_address:
      name: "${friendly_name} IP"
      id: ip_address

button:
  - platform: restart
    name: "${friendly_name} Restart"
    id: restart_btn
