substitutions:
  name: m5stack-atom-echo
  friendly_name: M5Stack Atom Echo

esphome:
  name: ${name}
  friendly_name: ${friendly_name}
  min_version: 2024.6.0
  on_boot:
    - priority: 600
      then:
        - light.turn_on:
            id: led
            effect: "Slow Pulse"
            red: 30%
            green: 30%
            blue: 70%

esp32:
  board: m5stack-atom
  framework:
    type: esp-idf

logger:

api:
  encryption:
    key: !secret api_encryption_key
  on_client_connected:
    - light.turn_on:
        id: led
        effect: none
        red: 0%
        green: 100%
        blue: 0%
        brightness: 50%
    - delay: 1s
    - light.turn_off: led
  on_client_disconnected:
    - light.turn_on:
        id: led
        effect: "Fast Pulse"
        red: 100%
        green: 0%
        blue: 0%

ota:
  - platform: esphome
    password: !secret ota_password

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  ap:
    ssid: "${name} Fallback"
    password: !secret fallback_password

# ----- Mikrofon (PDM) -----
microphone:
  - platform: i2s_audio
    id: atom_mic
    adc_type: external
    i2s_din_pin: GPIO23
    pdm: true

# ----- Högtalare -----
speaker:
  - platform: i2s_audio
    id: atom_speaker
    dac_type: external
    i2s_dout_pin: GPIO21
    mode: mono

# ----- I2S Audio -----
i2s_audio:
  - id: i2s_shared
    i2s_lrclk_pin: GPIO33
    i2s_bclk_pin: GPIO19

# ----- Voice Assistant -----
voice_assistant:
  id: va
  microphone: atom_mic
  speaker: atom_speaker
  use_wake_word: false  # Push-to-talk istället
  noise_suppression_level: 2
  auto_gain: 31dBFS
  volume_multiplier: 2.0

  on_listening:
    - light.turn_on:
        id: led
        effect: none
        red: 0%
        green: 0%
        blue: 100%
        brightness: 100%

  on_stt_vad_end:
    - light.turn_on:
        id: led
        effect: "Fast Pulse"
        red: 0%
        green: 100%
        blue: 100%

  on_tts_start:
    - light.turn_on:
        id: led
        effect: none
        red: 100%
        green: 50%
        blue: 0%
        brightness: 100%

  on_tts_end:
    - light.turn_off: led

  on_error:
    - light.turn_on:
        id: led
        effect: none
        red: 100%
        green: 0%
        blue: 0%
        brightness: 100%
    - delay: 2s
    - light.turn_off: led

  on_end:
    - light.turn_off: led

# ----- Push-to-Talk Knapp (GPIO39) -----
binary_sensor:
  - platform: gpio
    pin:
      number: GPIO39
      inverted: true
    name: "${friendly_name} Button"
    id: atom_button

    on_press:
      - voice_assistant.start:

    on_release:
      - voice_assistant.stop:

# ----- RGB LED (GPIO27) -----
light:
  - platform: esp32_rmt_led_strip
    id: led
    name: "${friendly_name} LED"
    pin: GPIO27
    chipset: SK6812
    num_leds: 1
    rgb_order: GRB
    rmt_channel: 0
    effects:
      - pulse:
          name: "Slow Pulse"
          transition_length: 1s
          update_interval: 1s
      - pulse:
          name: "Fast Pulse"
          transition_length: 250ms
          update_interval: 250ms
