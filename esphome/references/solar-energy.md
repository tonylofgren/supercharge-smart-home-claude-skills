# ESPHome Solar Energy Reference

Complete guide for solar inverter monitoring, battery management, and energy dashboards.

## Table of Contents
- [Overview](#overview)
- [Inverter Monitoring](#inverter-monitoring)
- [Battery Management](#battery-management)
- [CT Clamp Energy Monitoring](#ct-clamp-energy-monitoring)
- [Home Assistant Integration](#home-assistant-integration)
- [Complete Examples](#complete-examples)

---

## Overview

### Common Architectures

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  Solar PV   │────▶│  Inverter   │────▶│    Grid     │
└─────────────┘     └──────┬──────┘     └─────────────┘
                           │
                    ┌──────▼──────┐
                    │   Battery   │
                    └──────┬──────┘
                           │
                    ┌──────▼──────┐     ┌─────────────┐
                    │    ESP32    │────▶│ Home Assist │
                    │  (Monitor)  │     │   Energy    │
                    └─────────────┘     └─────────────┘
```

### Communication Protocols

| Protocol | Common Devices | Pins |
|----------|---------------|------|
| RS232 | Pipsolar, SMG-II | TX/RX |
| RS485/Modbus | PowMr, Deye, Sunsynk | A/B |
| VE.Direct | Victron | TX/RX |
| CAN Bus | Pylontech, Growatt | CANH/CANL |
| BLE | JK-BMS, Daly BMS | Wireless |

---

## Inverter Monitoring

### Victron MPPT (VE.Direct)

```yaml
# Generated by esphome-assistant v2.1.0
# https://github.com/tonylofgren/supercharge-smart-home-claude-skills

external_components:
  - source: github://KinDR007/VictronMPPT-ESPHOME@main
    components: [victron]

uart:
  tx_pin: GPIO1
  rx_pin: GPIO3
  baud_rate: 19200

victron:
  id: victron_mppt

sensor:
  - platform: victron
    victron_id: victron_mppt

    panel_voltage:
      name: "PV Voltage"
      unit_of_measurement: "V"

    panel_power:
      name: "PV Power"
      unit_of_measurement: "W"

    battery_voltage:
      name: "Battery Voltage"
      unit_of_measurement: "V"

    battery_current:
      name: "Battery Current"
      unit_of_measurement: "A"

    load_current:
      name: "Load Current"
      unit_of_measurement: "A"

    yield_today:
      name: "Yield Today"
      unit_of_measurement: "kWh"

    yield_yesterday:
      name: "Yield Yesterday"
      unit_of_measurement: "kWh"

    yield_total:
      name: "Yield Total"
      unit_of_measurement: "kWh"

    max_power_today:
      name: "Max Power Today"
      unit_of_measurement: "W"

text_sensor:
  - platform: victron
    victron_id: victron_mppt
    charging_mode:
      name: "Charging Mode"
    error:
      name: "Error"
```

### PowMr Hybrid Inverter (Modbus)

```yaml
external_components:
  - source: github://odya/esphome-powmr-hybrid-inverter@main
    components: [powmr_hybrid]

uart:
  id: modbus_uart
  tx_pin: GPIO17
  rx_pin: GPIO16
  baud_rate: 2400
  parity: NONE
  stop_bits: 1

modbus:
  id: modbus_hub
  uart_id: modbus_uart

powmr_hybrid:
  id: inverter
  modbus_id: modbus_hub
  address: 0x01
  update_interval: 5s

sensor:
  - platform: powmr_hybrid
    powmr_hybrid_id: inverter

    # PV Input
    pv_input_voltage:
      name: "PV Voltage"
    pv_input_power:
      name: "PV Power"

    # Battery
    battery_voltage:
      name: "Battery Voltage"
    battery_charging_current:
      name: "Battery Charging Current"
    battery_discharge_current:
      name: "Battery Discharge Current"
    battery_capacity:
      name: "Battery SOC"

    # Grid
    grid_voltage:
      name: "Grid Voltage"
    grid_frequency:
      name: "Grid Frequency"

    # Output
    ac_output_voltage:
      name: "Output Voltage"
    ac_output_frequency:
      name: "Output Frequency"
    output_load_percent:
      name: "Load Percent"
    output_load_va:
      name: "Load VA"
    output_load_watt:
      name: "Load Watts"

    # Temperature
    inverter_temperature:
      name: "Inverter Temperature"

select:
  - platform: powmr_hybrid
    output_source_priority:
      name: "Output Priority"
    charger_source_priority:
      name: "Charger Priority"
```

### Pipsolar / Voltronic (RS232)

```yaml
external_components:
  - source: github://syssi/esphome-pipsolar@main
    components: [pipsolar]

uart:
  tx_pin: GPIO1
  rx_pin: GPIO3
  baud_rate: 2400

pipsolar:
  id: inverter

sensor:
  - platform: pipsolar
    pipsolar_id: inverter

    grid_voltage:
      name: "Grid Voltage"
    grid_frequency:
      name: "Grid Frequency"

    ac_output_voltage:
      name: "AC Output Voltage"
    ac_output_frequency:
      name: "AC Output Frequency"
    ac_output_apparent_power:
      name: "AC Output VA"
    ac_output_active_power:
      name: "AC Output Watts"

    output_load_percent:
      name: "Load Percent"

    battery_voltage:
      name: "Battery Voltage"
    battery_charging_current:
      name: "Battery Charging Current"
    battery_capacity_percent:
      name: "Battery SOC"
    battery_discharge_current:
      name: "Battery Discharge Current"

    pv_input_voltage:
      name: "PV Voltage"
    pv_input_current:
      name: "PV Current"
    pv_input_power:
      name: "PV Power"

    inverter_heat_sink_temperature:
      name: "Inverter Temperature"

text_sensor:
  - platform: pipsolar
    pipsolar_id: inverter
    device_mode:
      name: "Device Mode"

switch:
  - platform: pipsolar
    pipsolar_id: inverter
    output_source_priority_utility:
      name: "Priority: Utility"
    output_source_priority_solar:
      name: "Priority: Solar"
    output_source_priority_battery:
      name: "Priority: Battery"
```

### Deye / Sunsynk (Modbus)

```yaml
uart:
  tx_pin: GPIO17
  rx_pin: GPIO16
  baud_rate: 9600

modbus:
  id: modbus_hub

modbus_controller:
  - id: deye
    address: 0x01
    modbus_id: modbus_hub
    update_interval: 5s

sensor:
  # PV Input
  - platform: modbus_controller
    modbus_controller_id: deye
    name: "PV1 Voltage"
    address: 0x006D
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    filters:
      - multiply: 0.1

  - platform: modbus_controller
    modbus_controller_id: deye
    name: "PV1 Power"
    address: 0x006F
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "W"

  # Battery
  - platform: modbus_controller
    modbus_controller_id: deye
    name: "Battery Voltage"
    address: 0x004E
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    filters:
      - multiply: 0.01

  - platform: modbus_controller
    modbus_controller_id: deye
    name: "Battery SOC"
    address: 0x004F
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "%"

  - platform: modbus_controller
    modbus_controller_id: deye
    name: "Battery Power"
    address: 0x0050
    register_type: holding
    value_type: S_WORD
    unit_of_measurement: "W"

  # Grid
  - platform: modbus_controller
    modbus_controller_id: deye
    name: "Grid Power"
    address: 0x0054
    register_type: holding
    value_type: S_WORD
    unit_of_measurement: "W"

  # Load
  - platform: modbus_controller
    modbus_controller_id: deye
    name: "Load Power"
    address: 0x0056
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "W"

  # Daily Energy
  - platform: modbus_controller
    modbus_controller_id: deye
    name: "Daily PV Energy"
    address: 0x006C
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "kWh"
    filters:
      - multiply: 0.1
```

---

## Battery Management

### JK-BMS (BLE)

```yaml
external_components:
  - source: github://syssi/esphome-jk-bms@main
    components: [jk_bms_ble]

esp32_ble_tracker:

jk_bms_ble:
  - id: jk_bms
    mac_address: "C8:47:8C:XX:XX:XX"

sensor:
  - platform: jk_bms_ble
    jk_bms_ble_id: jk_bms

    total_voltage:
      name: "Battery Voltage"
    current:
      name: "Battery Current"
    power:
      name: "Battery Power"
    state_of_charge:
      name: "Battery SOC"

    cell_voltage_1:
      name: "Cell 1"
    cell_voltage_2:
      name: "Cell 2"
    cell_voltage_3:
      name: "Cell 3"
    cell_voltage_4:
      name: "Cell 4"
    # ... up to 24 cells

    min_cell_voltage:
      name: "Min Cell Voltage"
    max_cell_voltage:
      name: "Max Cell Voltage"
    delta_cell_voltage:
      name: "Cell Voltage Delta"

    temperature_sensor_1:
      name: "BMS Temp 1"
    temperature_sensor_2:
      name: "BMS Temp 2"

    charging_cycles:
      name: "Charging Cycles"
    total_charging_cycle_capacity:
      name: "Total Capacity"

binary_sensor:
  - platform: jk_bms_ble
    jk_bms_ble_id: jk_bms
    charging:
      name: "Charging"
    discharging:
      name: "Discharging"
    balancing:
      name: "Balancing"
```

### JK-BMS (UART)

```yaml
external_components:
  - source: github://syssi/esphome-jk-bms@main
    components: [jk_bms]

uart:
  tx_pin: GPIO17
  rx_pin: GPIO16
  baud_rate: 115200

jk_bms:
  id: jk_bms_uart

sensor:
  - platform: jk_bms
    jk_bms_id: jk_bms_uart
    total_voltage:
      name: "Battery Voltage"
    current:
      name: "Battery Current"
    state_of_charge:
      name: "Battery SOC"
```

### DIY Shunt Monitor (INA226)

```yaml
i2c:
  sda: GPIO21
  scl: GPIO22

sensor:
  - platform: ina226
    address: 0x40
    shunt_resistance: 0.001 ohm
    max_current: 100A
    update_interval: 1s

    bus_voltage:
      name: "Battery Voltage"
    shunt_voltage:
      name: "Shunt Voltage"
    current:
      name: "Battery Current"
      filters:
        - multiply: -1  # Invert if needed
    power:
      name: "Battery Power"

  # Calculate energy
  - platform: total_daily_energy
    name: "Daily Charge Energy"
    power_id: battery_power
    filters:
      - lambda: "return x > 0 ? x : 0;"  # Only positive (charging)

  - platform: total_daily_energy
    name: "Daily Discharge Energy"
    power_id: battery_power
    filters:
      - lambda: "return x < 0 ? -x : 0;"  # Only negative (discharging)
```

---

## CT Clamp Energy Monitoring

### Whole-Home Monitoring (3-Phase)

```yaml
sensor:
  # Phase 1
  - platform: ct_clamp
    sensor: adc_phase1
    name: "Phase 1 Current"
    id: current_1
    sample_duration: 200ms
    update_interval: 5s

  - platform: template
    name: "Phase 1 Power"
    id: power_1
    lambda: |-
      return id(current_1).state * 230;  # Assumes 230V
    unit_of_measurement: "W"
    update_interval: 5s

  # Phase 2
  - platform: ct_clamp
    sensor: adc_phase2
    name: "Phase 2 Current"
    id: current_2
    sample_duration: 200ms
    update_interval: 5s

  - platform: template
    name: "Phase 2 Power"
    id: power_2
    lambda: |-
      return id(current_2).state * 230;
    unit_of_measurement: "W"

  # Phase 3
  - platform: ct_clamp
    sensor: adc_phase3
    name: "Phase 3 Current"
    id: current_3
    sample_duration: 200ms
    update_interval: 5s

  - platform: template
    name: "Phase 3 Power"
    id: power_3
    lambda: |-
      return id(current_3).state * 230;
    unit_of_measurement: "W"

  # Total Power
  - platform: template
    name: "Total Power"
    lambda: |-
      return id(power_1).state + id(power_2).state + id(power_3).state;
    unit_of_measurement: "W"
    update_interval: 5s

  # ADC Inputs
  - platform: adc
    id: adc_phase1
    pin: GPIO34
    attenuation: 11db
    internal: true

  - platform: adc
    id: adc_phase2
    pin: GPIO35
    attenuation: 11db
    internal: true

  - platform: adc
    id: adc_phase3
    pin: GPIO32
    attenuation: 11db
    internal: true

  # Daily Energy
  - platform: total_daily_energy
    name: "Daily Energy"
    power_id: total_power
    unit_of_measurement: "kWh"
    filters:
      - multiply: 0.001
```

### CT Clamp Calibration

```yaml
sensor:
  - platform: ct_clamp
    sensor: adc_input
    name: "Current"
    sample_duration: 200ms
    update_interval: 2s
    filters:
      # Calibrate based on CT ratio
      # SCT-013-000: 100A/50mA = 2000 turns ratio
      # With burden resistor, calibrate empirically
      - calibrate_linear:
          - 0.0 -> 0.0
          - 0.5 -> 25.0   # Measure at known load
          - 1.0 -> 50.0
```

---

## Home Assistant Integration

### Energy Dashboard Sensors

```yaml
sensor:
  # Grid import (positive = import)
  - platform: template
    name: "Grid Import"
    id: grid_import
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    lambda: |-
      float grid = id(grid_power).state;
      return grid > 0 ? grid : 0;

  # Grid export (negative = export)
  - platform: template
    name: "Grid Export"
    id: grid_export
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    lambda: |-
      float grid = id(grid_power).state;
      return grid < 0 ? -grid : 0;

  # Daily counters for HA Energy
  - platform: total_daily_energy
    name: "Daily Grid Import"
    power_id: grid_import
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    filters:
      - multiply: 0.001

  - platform: total_daily_energy
    name: "Daily Grid Export"
    power_id: grid_export
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    filters:
      - multiply: 0.001

  - platform: total_daily_energy
    name: "Daily Solar Production"
    power_id: pv_power
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    filters:
      - multiply: 0.001
```

### HA Energy Configuration

```yaml
# In HA configuration.yaml or via UI
homeassistant:
  customize:
    sensor.daily_solar_production:
      last_reset: "1970-01-01T00:00:00+00:00"
      state_class: total_increasing
      device_class: energy
```

---

## Complete Examples

### Victron + JK-BMS Monitor

```yaml
# Generated by esphome-assistant v2.1.0
# https://github.com/tonylofgren/supercharge-smart-home-claude-skills

substitutions:
  device_name: "solar-monitor"

esphome:
  name: ${device_name}

esp32:
  board: esp32dev

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

api:
ota:
logger:

external_components:
  - source: github://KinDR007/VictronMPPT-ESPHOME@main
    components: [victron]
  - source: github://syssi/esphome-jk-bms@main
    components: [jk_bms_ble]

uart:
  tx_pin: GPIO1
  rx_pin: GPIO3
  baud_rate: 19200

esp32_ble_tracker:

victron:
  id: mppt

jk_bms_ble:
  - id: bms
    mac_address: "C8:47:8C:XX:XX:XX"

sensor:
  # MPPT sensors
  - platform: victron
    victron_id: mppt
    panel_voltage:
      name: "PV Voltage"
    panel_power:
      name: "PV Power"
      id: pv_power
    battery_voltage:
      name: "MPPT Battery Voltage"
    yield_today:
      name: "Solar Today"

  # BMS sensors
  - platform: jk_bms_ble
    jk_bms_ble_id: bms
    total_voltage:
      name: "Battery Voltage"
    current:
      name: "Battery Current"
    power:
      name: "Battery Power"
    state_of_charge:
      name: "Battery SOC"
    delta_cell_voltage:
      name: "Cell Delta"
    temperature_sensor_1:
      name: "Battery Temp"

  # Daily solar energy
  - platform: total_daily_energy
    name: "Daily Solar"
    power_id: pv_power
    unit_of_measurement: "kWh"
    filters:
      - multiply: 0.001

text_sensor:
  - platform: victron
    victron_id: mppt
    charging_mode:
      name: "Charge State"

binary_sensor:
  - platform: jk_bms_ble
    jk_bms_ble_id: bms
    charging:
      name: "Charging"
    balancing:
      name: "Balancing"
```

### Modbus Energy Meter (SDM630)

```yaml
# Generated by esphome-assistant v2.1.0
# https://github.com/tonylofgren/supercharge-smart-home-claude-skills

uart:
  tx_pin: GPIO17
  rx_pin: GPIO16
  baud_rate: 9600
  parity: NONE

modbus:
  id: modbus_hub

modbus_controller:
  - id: sdm630
    address: 0x01
    modbus_id: modbus_hub
    update_interval: 5s

sensor:
  # Phase Voltages
  - platform: modbus_controller
    modbus_controller_id: sdm630
    name: "L1 Voltage"
    address: 0x0000
    register_type: read
    value_type: FP32
    unit_of_measurement: "V"

  - platform: modbus_controller
    modbus_controller_id: sdm630
    name: "L2 Voltage"
    address: 0x0002
    register_type: read
    value_type: FP32
    unit_of_measurement: "V"

  - platform: modbus_controller
    modbus_controller_id: sdm630
    name: "L3 Voltage"
    address: 0x0004
    register_type: read
    value_type: FP32
    unit_of_measurement: "V"

  # Phase Currents
  - platform: modbus_controller
    modbus_controller_id: sdm630
    name: "L1 Current"
    address: 0x0006
    register_type: read
    value_type: FP32
    unit_of_measurement: "A"

  # Total Power
  - platform: modbus_controller
    modbus_controller_id: sdm630
    name: "Total Power"
    address: 0x0034
    register_type: read
    value_type: FP32
    unit_of_measurement: "W"

  # Total Energy
  - platform: modbus_controller
    modbus_controller_id: sdm630
    name: "Total Energy"
    address: 0x0156
    register_type: read
    value_type: FP32
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
```
