# Generated by ha-yaml@aurora-smart-home v1.0.0
# https://github.com/tonylofgren/aurora-smart-home
#
# Energy Optimization Automation Template
# Demonstrates grid-aware scheduling, spot price optimization, and load management
#
# Features:
# - Spot price-based automation
# - Solar surplus utilization
# - Load shifting and balancing
# - EV charging optimization
# - Peak hour avoidance

# ============================================================
# PREREQUISITES
# ============================================================
# Required integrations:
# - Nordpool (for spot prices) or similar electricity price sensor
# - Power monitoring sensor (e.g., from smart meter)
# - Optional: Solar production sensor, EV charger, battery storage

# ============================================================
# EXAMPLE 1: Spot Price-Based Appliance Control
# ============================================================
# Runs high-consumption appliances during low-price periods

automation:
  - id: energy_cheap_hour_appliances
    alias: "Energy: Run Appliances During Cheap Hours"
    description: "Triggers appliances when electricity is cheap"
    mode: single

    trigger:
      # Check every hour
      - platform: time_pattern
        hours: "/1"

    variables:
      # Get current and upcoming prices
      current_price: "{{ states('sensor.nordpool_kwh_se3_sek_3_10_025') | float(1) }}"
      daily_average: "{{ state_attr('sensor.nordpool_kwh_se3_sek_3_10_025', 'average') | float(1) }}"
      price_threshold: "{{ daily_average * 0.7 }}"  # 30% below average

      # Check if now is a good time
      is_cheap: "{{ current_price < price_threshold }}"

      # Pending appliances to run
      pending_wash: "{{ is_state('input_boolean.pending_washing_machine', 'on') }}"
      pending_dryer: "{{ is_state('input_boolean.pending_dryer', 'on') }}"
      pending_dishwasher: "{{ is_state('input_boolean.pending_dishwasher', 'on') }}"

    condition:
      - condition: template
        value_template: "{{ is_cheap }}"
      - condition: template
        value_template: "{{ pending_wash or pending_dryer or pending_dishwasher }}"

    action:
      # Start pending appliances in sequence
      - if:
          - condition: template
            value_template: "{{ pending_wash }}"
        then:
          - service: switch.turn_on
            target:
              entity_id: switch.washing_machine_smart_plug
          - service: input_boolean.turn_off
            target:
              entity_id: input_boolean.pending_washing_machine
          - service: notify.mobile_app
            data:
              title: "Energy Optimization"
              message: >
                Starting washing machine during cheap hour
                ({{ current_price | round(2) }} SEK/kWh)

      - if:
          - condition: template
            value_template: "{{ pending_dishwasher }}"
        then:
          - service: switch.turn_on
            target:
              entity_id: switch.dishwasher_smart_plug
          - service: input_boolean.turn_off
            target:
              entity_id: input_boolean.pending_dishwasher

# ============================================================
# EXAMPLE 2: Solar Surplus Utilization
# ============================================================
# Uses excess solar power for beneficial loads

  - id: energy_solar_surplus
    alias: "Energy: Use Solar Surplus"
    description: "Activates loads when solar exceeds consumption"
    mode: single

    trigger:
      - platform: template
        value_template: >
          {% set solar = states('sensor.solar_production') | float(0) %}
          {% set usage = states('sensor.power_consumption') | float(0) %}
          {% set surplus = solar - usage %}
          {{ surplus > 500 }}  # 500W surplus threshold
        for:
          minutes: 5  # Stable surplus

    variables:
      solar: "{{ states('sensor.solar_production') | float(0) }}"
      usage: "{{ states('sensor.power_consumption') | float(0) }}"
      surplus: "{{ solar - usage }}"

    action:
      - choose:
          # Large surplus (>2000W) - start EV charging
          - conditions:
              - condition: template
                value_template: "{{ surplus > 2000 }}"
              - condition: state
                entity_id: binary_sensor.ev_plugged_in
                state: "on"
              - condition: template
                value_template: "{{ states('sensor.ev_battery') | int < 80 }}"
            sequence:
              - service: switch.turn_on
                target:
                  entity_id: switch.ev_charger
              - service: number.set_value
                target:
                  entity_id: number.ev_charging_amps
                data:
                  value: "{{ ((surplus / 230) | int) | min(16) }}"  # Max 16A
              - service: notify.mobile_app
                data:
                  message: "Charging EV with {{ surplus | round(0) }}W solar surplus"

          # Medium surplus (>1000W) - heat water
          - conditions:
              - condition: template
                value_template: "{{ surplus > 1000 }}"
              - condition: template
                value_template: "{{ states('sensor.water_heater_temp') | float < 55 }}"
            sequence:
              - service: switch.turn_on
                target:
                  entity_id: switch.water_heater_boost

          # Small surplus (>500W) - charge batteries
          - conditions:
              - condition: template
                value_template: "{{ surplus > 500 }}"
              - condition: template
                value_template: "{{ states('sensor.home_battery') | int < 90 }}"
            sequence:
              - service: switch.turn_on
                target:
                  entity_id: switch.battery_charge_mode

# ============================================================
# EXAMPLE 3: Peak Hour Load Shedding
# ============================================================
# Reduces consumption during expensive peak hours

  - id: energy_peak_avoidance
    alias: "Energy: Peak Hour Load Shedding"
    description: "Reduces non-essential loads during peak prices"
    mode: single

    trigger:
      # Price crosses threshold
      - platform: numeric_state
        entity_id: sensor.nordpool_kwh_se3_sek_3_10_025
        above: input_number.peak_price_threshold
        id: peak_start

      - platform: numeric_state
        entity_id: sensor.nordpool_kwh_se3_sek_3_10_025
        below: input_number.peak_price_threshold
        id: peak_end

    action:
      - choose:
          # Peak started - reduce loads
          - conditions:
              - condition: trigger
                id: peak_start
            sequence:
              # Save current states
              - service: scene.create
                data:
                  scene_id: pre_peak_state
                  snapshot_entities:
                    - climate.living_room
                    - switch.water_heater
                    - switch.pool_pump

              # Reduce heating/cooling
              - service: climate.set_temperature
                target:
                  entity_id: climate.living_room
                data:
                  temperature: >
                    {% set current = state_attr('climate.living_room', 'temperature') | float(21) %}
                    {% set mode = states('climate.living_room') %}
                    {% if mode == 'heat' %}
                      {{ current - 2 }}
                    {% elif mode == 'cool' %}
                      {{ current + 2 }}
                    {% else %}
                      {{ current }}
                    {% endif %}

              # Turn off non-essential loads
              - service: switch.turn_off
                target:
                  entity_id:
                    - switch.water_heater
                    - switch.pool_pump
                    - switch.floor_heating_boost

              - service: notify.mobile_app
                data:
                  title: "Peak Price Active"
                  message: >
                    Electricity at {{ states('sensor.nordpool_kwh_se3_sek_3_10_025') | round(2) }} SEK/kWh.
                    Reducing non-essential loads.

          # Peak ended - restore
          - conditions:
              - condition: trigger
                id: peak_end
            sequence:
              - service: scene.turn_on
                target:
                  entity_id: scene.pre_peak_state
              - service: notify.mobile_app
                data:
                  title: "Peak Price Ended"
                  message: "Restoring normal operation"

# ============================================================
# EXAMPLE 4: EV Charging Optimization
# ============================================================
# Charges EV during cheapest hours to reach target by departure time

  - id: energy_ev_smart_charging
    alias: "Energy: Smart EV Charging"
    description: "Schedules EV charging during cheapest hours"
    mode: single

    trigger:
      # When car plugged in
      - platform: state
        entity_id: binary_sensor.ev_plugged_in
        to: "on"
        id: plugged_in

      # Every hour during night (for recalculation)
      - platform: time_pattern
        hours: "/1"
        id: hourly_check

    condition:
      - condition: state
        entity_id: binary_sensor.ev_plugged_in
        state: "on"

    action:
      - variables:
          # Charging parameters
          current_soc: "{{ states('sensor.ev_battery') | int(50) }}"
          target_soc: "{{ states('input_number.ev_target_soc') | int(80) }}"
          departure_time: "{{ states('input_datetime.ev_departure_time') }}"

          # Calculate required energy (kWh)
          battery_capacity: 60  # kWh
          energy_needed: "{{ ((target_soc - current_soc) / 100 * battery_capacity) | round(1) }}"

          # Charging rate (kW)
          charge_rate: 7.4  # Home charger
          hours_needed: "{{ (energy_needed / charge_rate) | round(1) }}"

          # Get prices for next 24h
          prices: "{{ state_attr('sensor.nordpool_kwh_se3_sek_3_10_025', 'raw_today') }}"
          prices_tomorrow: "{{ state_attr('sensor.nordpool_kwh_se3_sek_3_10_025', 'raw_tomorrow') }}"

          # Find cheapest hours
          cheapest_hours: >
            {% set all_prices = prices + (prices_tomorrow | default([])) %}
            {% set ns = namespace(hours=[]) %}
            {% for p in all_prices | sort(attribute='value') %}
              {% if ns.hours | length < hours_needed | int + 1 %}
                {% set ns.hours = ns.hours + [p.start] %}
              {% endif %}
            {% endfor %}
            {{ ns.hours }}

      # Determine if we should charge now
      - variables:
          current_hour: "{{ now().replace(minute=0, second=0, microsecond=0).isoformat() }}"
          should_charge: "{{ current_hour in cheapest_hours }}"

      - choose:
          # Should be charging
          - conditions:
              - condition: template
                value_template: "{{ should_charge }}"
              - condition: template
                value_template: "{{ current_soc < target_soc }}"
            sequence:
              - service: switch.turn_on
                target:
                  entity_id: switch.ev_charger

          # Should not be charging
          - conditions:
              - condition: template
                value_template: "{{ not should_charge }}"
            sequence:
              - service: switch.turn_off
                target:
                  entity_id: switch.ev_charger

# ============================================================
# EXAMPLE 5: Load Balancing
# ============================================================
# Prevents main fuse overload by managing concurrent loads

  - id: energy_load_balancing
    alias: "Energy: Load Balancing"
    description: "Prevents circuit overload"
    mode: single

    trigger:
      - platform: numeric_state
        entity_id: sensor.main_power
        above: input_number.power_limit_warning  # e.g., 15000W for 20A main fuse
        for:
          seconds: 30

    variables:
      current_load: "{{ states('sensor.main_power') | float(0) }}"
      limit: "{{ states('input_number.power_limit_warning') | float(15000) }}"
      overload: "{{ current_load - limit }}"

      # Load priorities (lowest = shed first)
      loads:
        - entity: switch.ev_charger
          power: 7400
          priority: 1
        - entity: switch.water_heater
          power: 2000
          priority: 2
        - entity: switch.pool_pump
          power: 1500
          priority: 3
        - entity: switch.floor_heating
          power: 1000
          priority: 4

    action:
      - variables:
          # Sort by priority and find what to shed
          to_shed: >
            {% set ns = namespace(shed=[], freed=0) %}
            {% for load in loads | sort(attribute='priority') %}
              {% if is_state(load.entity, 'on') and ns.freed < overload %}
                {% set ns.shed = ns.shed + [load.entity] %}
                {% set ns.freed = ns.freed + load.power %}
              {% endif %}
            {% endfor %}
            {{ ns.shed }}

      # Shed loads
      - repeat:
          for_each: "{{ to_shed }}"
          sequence:
            - service: switch.turn_off
              target:
                entity_id: "{{ repeat.item }}"

      - service: notify.mobile_app
        data:
          title: "Load Balancing Active"
          message: >
            Power limit ({{ limit | int }}W) exceeded.
            Temporarily disabled: {{ to_shed | join(', ') | replace('switch.', '') }}

      # Try to restore after 30 minutes if load decreased
      - delay:
          minutes: 30

      - condition: template
        value_template: >
          {{ states('sensor.main_power') | float(0) < (limit - 3000) }}

      - repeat:
          for_each: "{{ to_shed }}"
          sequence:
            - service: switch.turn_on
              target:
                entity_id: "{{ repeat.item }}"
            - delay:
                seconds: 10  # Stagger startup

# ============================================================
# SUPPORTING ENTITIES
# ============================================================

input_number:
  peak_price_threshold:
    name: "Peak Price Threshold"
    unit_of_measurement: "SEK/kWh"
    min: 0.5
    max: 5.0
    step: 0.1
    initial: 2.0
    icon: mdi:currency-usd

  power_limit_warning:
    name: "Power Limit Warning"
    unit_of_measurement: "W"
    min: 5000
    max: 25000
    step: 500
    initial: 15000
    icon: mdi:flash-alert

  ev_target_soc:
    name: "EV Target SOC"
    unit_of_measurement: "%"
    min: 20
    max: 100
    step: 5
    initial: 80
    icon: mdi:battery-charging

input_boolean:
  pending_washing_machine:
    name: "Washing Machine Pending"
    icon: mdi:washing-machine

  pending_dryer:
    name: "Dryer Pending"
    icon: mdi:tumble-dryer

  pending_dishwasher:
    name: "Dishwasher Pending"
    icon: mdi:dishwasher

input_datetime:
  ev_departure_time:
    name: "EV Departure Time"
    has_time: true
    has_date: false
    icon: mdi:clock-start

# Template sensors for energy dashboard
template:
  - sensor:
      - name: "Energy Cost Today"
        unit_of_measurement: "SEK"
        device_class: monetary
        state: >
          {% set consumption = states('sensor.daily_energy_consumption') | float(0) %}
          {% set avg_price = state_attr('sensor.nordpool_kwh_se3_sek_3_10_025', 'average') | float(1) %}
          {{ (consumption * avg_price) | round(2) }}

      - name: "Savings Today"
        unit_of_measurement: "SEK"
        device_class: monetary
        state: >
          {% set consumption = states('sensor.daily_energy_consumption') | float(0) %}
          {% set avg_price = state_attr('sensor.nordpool_kwh_se3_sek_3_10_025', 'average') | float(1) %}
          {% set max_price = state_attr('sensor.nordpool_kwh_se3_sek_3_10_025', 'max') | float(1) %}
          {{ ((max_price - avg_price) * consumption) | round(2) }}
