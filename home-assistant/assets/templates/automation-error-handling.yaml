# Generated by ha-yaml@aurora-smart-home v1.0.0
# https://github.com/tonylofgren/aurora-smart-home
#
# Error Handling Automation Template
# Demonstrates retry logic, rollback patterns, and error notification
#
# Features:
# - Service call retry with exponential backoff
# - Error detection and notification
# - Rollback to previous state on failure
# - Dead letter handling for persistent failures

# ============================================================
# EXAMPLE 1: Service Call with Retry Logic
# ============================================================
# Retries a failed service call up to 3 times with delays

automation:
  - id: error_handling_retry_example
    alias: "Error Handling: Retry Service Call"
    description: "Demonstrates retry pattern for unreliable services"
    mode: single

    trigger:
      - platform: state
        entity_id: input_boolean.trigger_action
        to: "on"

    variables:
      max_retries: 3
      target_device: light.unreliable_smart_bulb

    action:
      # Track retry attempts
      - repeat:
          count: "{{ max_retries }}"
          sequence:
            - variables:
                attempt: "{{ repeat.index }}"

            # Try the service call
            - service: light.turn_on
              target:
                entity_id: "{{ target_device }}"
              data:
                brightness_pct: 100
              continue_on_error: true
              response_variable: result

            # Wait a moment for state to update
            - delay:
                seconds: 2

            # Check if it worked
            - if:
                - condition: state
                  entity_id: "{{ target_device }}"
                  state: "on"
              then:
                - stop: "Success on attempt {{ attempt }}"

            # Log the failure
            - service: logbook.log
              data:
                name: "Error Handling"
                message: "Attempt {{ attempt }}/{{ max_retries }} failed for {{ target_device }}"
                entity_id: "{{ target_device }}"

            # Exponential backoff delay (only if not last attempt)
            - if:
                - condition: template
                  value_template: "{{ attempt < max_retries }}"
              then:
                - delay:
                    seconds: "{{ 2 ** attempt }}"  # 2, 4, 8 seconds

      # All retries failed - notify
      - service: notify.mobile_app
        data:
          title: "Automation Failed"
          message: "Could not control {{ target_device }} after {{ max_retries }} attempts"
          data:
            tag: "error-{{ target_device }}"
            importance: high

# ============================================================
# EXAMPLE 2: Rollback on Failure
# ============================================================
# Saves state before action, rolls back if subsequent steps fail

  - id: error_handling_rollback_example
    alias: "Error Handling: Rollback Pattern"
    description: "Saves state and rolls back on failure"
    mode: single

    trigger:
      - platform: state
        entity_id: input_boolean.start_scene
        to: "on"

    variables:
      target_lights:
        - light.living_room
        - light.kitchen
        - light.hallway

    action:
      # ---- SAVE CURRENT STATE ----
      - variables:
          saved_states: >
            {% set ns = namespace(states=[]) %}
            {% for light in target_lights %}
              {% set current = states(light) %}
              {% set brightness = state_attr(light, 'brightness') | default(255, true) %}
              {% set ns.states = ns.states + [{
                'entity_id': light,
                'state': current,
                'brightness': brightness
              }] %}
            {% endfor %}
            {{ ns.states }}

      # ---- ATTEMPT NEW SCENE ----
      - service: light.turn_on
        target:
          entity_id: "{{ target_lights }}"
        data:
          brightness_pct: 50
          color_temp: 400
        continue_on_error: true

      # ---- VERIFY SUCCESS ----
      - delay:
          seconds: 2

      - variables:
          all_success: >
            {% set ns = namespace(success=true) %}
            {% for light in target_lights %}
              {% if states(light) != 'on' %}
                {% set ns.success = false %}
              {% endif %}
            {% endfor %}
            {{ ns.success }}

      # ---- ROLLBACK IF FAILED ----
      - if:
          - condition: template
            value_template: "{{ not all_success }}"
        then:
          # Restore each light to previous state
          - repeat:
              for_each: "{{ saved_states }}"
              sequence:
                - if:
                    - condition: template
                      value_template: "{{ repeat.item.state == 'on' }}"
                  then:
                    - service: light.turn_on
                      target:
                        entity_id: "{{ repeat.item.entity_id }}"
                      data:
                        brightness: "{{ repeat.item.brightness }}"
                  else:
                    - service: light.turn_off
                      target:
                        entity_id: "{{ repeat.item.entity_id }}"

          # Notify about rollback
          - service: notify.mobile_app
            data:
              title: "Scene Rolled Back"
              message: "Failed to set scene, restored previous state"

# ============================================================
# EXAMPLE 3: Error Detection and Notification
# ============================================================
# Monitors for errors and sends intelligent notifications

  - id: error_handling_monitoring
    alias: "Error Handling: Monitor and Alert"
    description: "Detects automation errors and notifies"
    mode: queued
    max: 10

    trigger:
      # Watch for automation failures
      - platform: event
        event_type: automation_triggered
        id: automation_event

      # Watch for service call errors
      - platform: event
        event_type: call_service
        id: service_event

    condition:
      # Only process failures
      - condition: template
        value_template: >
          {% if trigger.id == 'automation_event' %}
            {{ trigger.event.data.result is defined and
               trigger.event.data.result != 'ok' }}
          {% else %}
            {{ trigger.event.data.response is defined and
               trigger.event.data.response.error is defined }}
          {% endif %}

    action:
      - variables:
          error_info: >
            {% if trigger.id == 'automation_event' %}
              Automation: {{ trigger.event.data.name }}
              Error: {{ trigger.event.data.result | default('Unknown') }}
            {% else %}
              Service: {{ trigger.event.data.domain }}.{{ trigger.event.data.service }}
              Error: {{ trigger.event.data.response.error | default('Unknown') }}
            {% endif %}

      # Rate limit notifications (max 1 per 5 minutes)
      - condition: template
        value_template: >
          {% set last = state_attr('input_datetime.last_error_notification', 'timestamp') | default(0) %}
          {{ (as_timestamp(now()) - last) > 300 }}

      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.last_error_notification
        data:
          datetime: "{{ now().isoformat() }}"

      - service: notify.mobile_app
        data:
          title: "Home Assistant Error"
          message: "{{ error_info }}"
          data:
            tag: "ha-error"
            importance: high
            actions:
              - action: VIEW_LOGS
                title: "View Logs"
              - action: DISMISS_ERROR
                title: "Dismiss"

# ============================================================
# EXAMPLE 4: Dead Letter Queue for Failed Actions
# ============================================================
# Stores failed actions for later processing or manual review

  - id: error_handling_dead_letter
    alias: "Error Handling: Dead Letter Queue"
    description: "Saves failed actions for later retry"
    mode: queued
    max: 20

    trigger:
      - platform: event
        event_type: automation_error_occurred

    action:
      - variables:
          error_entry: >
            {{ {
              'timestamp': now().isoformat(),
              'automation': trigger.event.data.automation | default('unknown'),
              'error': trigger.event.data.error | default('unknown'),
              'context': trigger.event.data.context | default({})
            } }}

      # Append to dead letter queue (stored in file notification or input_text)
      - service: notify.file
        data:
          message: "{{ error_entry | to_json }}"
          target: /config/dead_letter_queue.json

      # Increment error counter
      - service: counter.increment
        target:
          entity_id: counter.automation_errors_today

      # Alert if too many errors
      - if:
          - condition: template
            value_template: >
              {{ states('counter.automation_errors_today') | int > 10 }}
        then:
          - service: notify.mobile_app
            data:
              title: "High Error Rate"
              message: >
                {{ states('counter.automation_errors_today') }} automation errors today.
                Check dead letter queue.

# ============================================================
# SUPPORTING ENTITIES (Required for examples above)
# ============================================================

input_boolean:
  trigger_action:
    name: "Trigger Action"
    icon: mdi:play

  start_scene:
    name: "Start Scene"
    icon: mdi:palette

input_datetime:
  last_error_notification:
    name: "Last Error Notification"
    has_date: true
    has_time: true

counter:
  automation_errors_today:
    name: "Automation Errors Today"
    icon: mdi:alert-circle
    initial: 0
    step: 1

# Reset error counter daily
automation:
  - id: error_counter_reset
    alias: "Error Counter: Daily Reset"
    trigger:
      - platform: time
        at: "00:00:00"
    action:
      - service: counter.reset
        target:
          entity_id: counter.automation_errors_today
