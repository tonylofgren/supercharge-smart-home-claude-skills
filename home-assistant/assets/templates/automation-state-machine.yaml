# Multi-State Automation Pattern Template
# Generated by ha-yaml@aurora-smart-home v1.0.0
# https://github.com/tonylofgren/aurora-smart-home
#
# This template demonstrates a state machine pattern for complex
# presence detection with multiple states and transitions.
#
# States: Present -> Recently_Left -> Away -> Extended_Away -> Arriving -> Present

# Required helpers
input_select:
  presence_state:
    name: "Presence State"
    options:
      - Present
      - Recently_Left
      - Away
      - Extended_Away
      - Arriving
    icon: mdi:home-account

timer:
  recently_left_timeout:
    name: "Recently Left Timeout"
    duration: "00:30:00"  # Time before transitioning to Away

  extended_away_timeout:
    name: "Extended Away Timeout"
    duration: "24:00:00"  # Time before Extended Away

input_datetime:
  last_state_change:
    name: "Last Presence State Change"
    has_date: true
    has_time: true

# Template sensor for state duration
template:
  - sensor:
      - name: "Presence State Duration"
        state: >
          {% set last = states('input_datetime.last_state_change') %}
          {% if last not in ['unknown', 'unavailable'] %}
            {% set duration = now() - strptime(last, '%Y-%m-%d %H:%M:%S') %}
            {{ duration.total_seconds() | int // 60 }} minutes
          {% else %}
            unknown
          {% endif %}

automation:
  # STATE TRANSITIONS

  # Present -> Recently_Left (when no one detected)
  - id: state_present_to_recently_left
    alias: "State: Present to Recently Left"
    trigger:
      - platform: state
        entity_id: binary_sensor.anyone_home  # Replace with your presence sensor
        to: "off"
    condition:
      - condition: state
        entity_id: input_select.presence_state
        state: "Present"
    action:
      - service: input_select.select_option
        target:
          entity_id: input_select.presence_state
        data:
          option: "Recently_Left"
      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.last_state_change
        data:
          datetime: "{{ now().strftime('%Y-%m-%d %H:%M:%S') }}"
      - service: timer.start
        target:
          entity_id: timer.recently_left_timeout

  # Recently_Left -> Present (quick return)
  - id: state_recently_left_to_present
    alias: "State: Recently Left to Present"
    trigger:
      - platform: state
        entity_id: binary_sensor.anyone_home
        to: "on"
    condition:
      - condition: state
        entity_id: input_select.presence_state
        state: "Recently_Left"
    action:
      - service: timer.cancel
        target:
          entity_id: timer.recently_left_timeout
      - service: input_select.select_option
        target:
          entity_id: input_select.presence_state
        data:
          option: "Present"
      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.last_state_change
        data:
          datetime: "{{ now().strftime('%Y-%m-%d %H:%M:%S') }}"

  # Recently_Left -> Away (timeout expired)
  - id: state_recently_left_to_away
    alias: "State: Recently Left to Away"
    trigger:
      - platform: event
        event_type: timer.finished
        event_data:
          entity_id: timer.recently_left_timeout
    action:
      - service: input_select.select_option
        target:
          entity_id: input_select.presence_state
        data:
          option: "Away"
      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.last_state_change
        data:
          datetime: "{{ now().strftime('%Y-%m-%d %H:%M:%S') }}"
      - service: timer.start
        target:
          entity_id: timer.extended_away_timeout
      # Execute away mode actions
      - service: script.turn_on
        target:
          entity_id: script.enter_away_mode

  # Away -> Extended_Away (long absence)
  - id: state_away_to_extended_away
    alias: "State: Away to Extended Away"
    trigger:
      - platform: event
        event_type: timer.finished
        event_data:
          entity_id: timer.extended_away_timeout
    action:
      - service: input_select.select_option
        target:
          entity_id: input_select.presence_state
        data:
          option: "Extended_Away"
      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.last_state_change
        data:
          datetime: "{{ now().strftime('%Y-%m-%d %H:%M:%S') }}"
      # Execute extended away actions
      - service: script.turn_on
        target:
          entity_id: script.enter_extended_away

  # Away/Extended_Away -> Arriving (approaching home)
  - id: state_away_to_arriving
    alias: "State: Away to Arriving"
    trigger:
      - platform: numeric_state
        entity_id: sensor.YOUR_PHONE_distance  # Replace with your distance sensor
        below: 1000  # meters
    condition:
      - condition: state
        entity_id: input_select.presence_state
        state:
          - "Away"
          - "Extended_Away"
    action:
      - service: timer.cancel
        target:
          entity_id: timer.extended_away_timeout
      - service: input_select.select_option
        target:
          entity_id: input_select.presence_state
        data:
          option: "Arriving"
      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.last_state_change
        data:
          datetime: "{{ now().strftime('%Y-%m-%d %H:%M:%S') }}"
      # Pre-arrival actions
      - service: script.turn_on
        target:
          entity_id: script.prepare_for_arrival

  # Arriving -> Present (arrived)
  - id: state_arriving_to_present
    alias: "State: Arriving to Present"
    trigger:
      - platform: state
        entity_id: binary_sensor.anyone_home
        to: "on"
    condition:
      - condition: state
        entity_id: input_select.presence_state
        state: "Arriving"
    action:
      - service: input_select.select_option
        target:
          entity_id: input_select.presence_state
        data:
          option: "Present"
      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.last_state_change
        data:
          datetime: "{{ now().strftime('%Y-%m-%d %H:%M:%S') }}"
      # Welcome home actions
      - service: script.turn_on
        target:
          entity_id: script.welcome_home

  # STATE ENTRY SCRIPTS

script:
  enter_away_mode:
    alias: "Enter Away Mode"
    sequence:
      - service: light.turn_off
        target:
          entity_id: all
      - service: climate.set_temperature
        target:
          entity_id: climate.YOUR_THERMOSTAT
        data:
          temperature: 17

  enter_extended_away:
    alias: "Enter Extended Away Mode"
    sequence:
      # Lower temperature further
      - service: climate.set_temperature
        target:
          entity_id: climate.YOUR_THERMOSTAT
        data:
          temperature: 15
      # Notify about extended absence
      - service: notify.mobile_app
        data:
          message: "Extended away mode activated (24+ hours)"

  prepare_for_arrival:
    alias: "Prepare for Arrival"
    sequence:
      # Preheat home
      - service: climate.set_temperature
        target:
          entity_id: climate.YOUR_THERMOSTAT
        data:
          temperature: 21
      # Turn on outdoor lights if dark
      - condition: sun
        after: sunset
      - service: light.turn_on
        target:
          entity_id: light.outdoor

  welcome_home:
    alias: "Welcome Home"
    sequence:
      - service: light.turn_on
        target:
          entity_id: light.hallway
        data:
          brightness_pct: 100
