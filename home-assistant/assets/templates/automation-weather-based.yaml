# Generated by ha-yaml@aurora-smart-home v1.0.0
# https://github.com/tonylofgren/aurora-smart-home
#
# Weather-Based Automation Template
# Demonstrates modern weather.get_forecasts service (2024.1+)
#
# Features:
# - Forecast-based automation triggers
# - Rain/storm preparation
# - Temperature-adaptive climate control
# - UV protection automation

# ============================================================
# EXAMPLE 1: Rain Preparation Automation
# ============================================================
# Closes covers and notifies before rain arrives

automation:
  - id: weather_rain_preparation
    alias: "Weather: Rain Preparation"
    description: "Prepares home before rain using forecast"
    mode: single

    trigger:
      # Check forecast every 30 minutes
      - platform: time_pattern
        minutes: "/30"

    action:
      # Get hourly forecast
      - service: weather.get_forecasts
        target:
          entity_id: weather.home
        data:
          type: hourly
        response_variable: forecast

      # Check next 3 hours for rain
      - variables:
          rain_coming: >
            {% set conditions = ['rainy', 'pouring', 'lightning', 'lightning-rainy', 'hail'] %}
            {% set hours = forecast['weather.home'].forecast[:3] %}
            {% set ns = namespace(rain=false) %}
            {% for hour in hours %}
              {% if hour.condition in conditions %}
                {% set ns.rain = true %}
              {% endif %}
            {% endfor %}
            {{ ns.rain }}
          rain_time: >
            {% set conditions = ['rainy', 'pouring', 'lightning', 'lightning-rainy', 'hail'] %}
            {% set hours = forecast['weather.home'].forecast[:3] %}
            {% for hour in hours %}
              {% if hour.condition in conditions %}
                {{ hour.datetime }}
                {% break %}
              {% endif %}
            {% endfor %}

      - if:
          - condition: template
            value_template: "{{ rain_coming }}"
          - condition: state
            entity_id: input_boolean.rain_prepared
            state: "off"
        then:
          # Close outdoor covers
          - service: cover.close_cover
            target:
              entity_id:
                - cover.patio_awning
                - cover.balcony_shade

          # Notify residents
          - service: notify.mobile_app
            data:
              title: "Rain Expected"
              message: >
                Rain forecast around {{ as_timestamp(rain_time) | timestamp_custom('%H:%M') }}.
                Closing outdoor covers.
              data:
                tag: weather-rain

          # Mark as prepared (prevent repeated actions)
          - service: input_boolean.turn_on
            target:
              entity_id: input_boolean.rain_prepared

# ============================================================
# EXAMPLE 2: Temperature-Adaptive Climate
# ============================================================
# Adjusts heating/cooling based on weather forecast

  - id: weather_adaptive_climate
    alias: "Weather: Adaptive Climate Control"
    description: "Pre-heats or pre-cools based on forecast"
    mode: single

    trigger:
      # Run at 6 AM to prepare for the day
      - platform: time
        at: "06:00:00"
        id: morning

      # Also run at 2 PM for afternoon adjustments
      - platform: time
        at: "14:00:00"
        id: afternoon

    action:
      # Get daily forecast
      - service: weather.get_forecasts
        target:
          entity_id: weather.home
        data:
          type: daily
        response_variable: daily_forecast

      # Get hourly for more precision
      - service: weather.get_forecasts
        target:
          entity_id: weather.home
        data:
          type: hourly
        response_variable: hourly_forecast

      - variables:
          # Today's high temperature
          today_high: "{{ daily_forecast['weather.home'].forecast[0].temperature }}"
          today_low: "{{ daily_forecast['weather.home'].forecast[0].templow }}"

          # Next 6 hours forecast
          next_hours: "{{ hourly_forecast['weather.home'].forecast[:6] }}"

          # Average temperature next 6 hours
          avg_temp: >
            {% set temps = next_hours | map(attribute='temperature') | list %}
            {{ (temps | sum / temps | length) | round(1) }}

          # Current indoor temperature
          indoor_temp: "{{ states('sensor.indoor_temperature') | float(20) }}"

      # Determine climate action
      - choose:
          # Hot day coming - pre-cool the house
          - conditions:
              - condition: template
                value_template: "{{ today_high | float > 28 }}"
              - condition: trigger
                id: morning
            sequence:
              - service: climate.set_temperature
                target:
                  entity_id: climate.living_room
                data:
                  hvac_mode: cool
                  temperature: 23
              - service: notify.mobile_app
                data:
                  title: "Climate Adjustment"
                  message: >
                    Hot day expected ({{ today_high }}°C). Pre-cooling house.

          # Cold day coming - pre-heat the house
          - conditions:
              - condition: template
                value_template: "{{ today_low | float < 5 }}"
              - condition: trigger
                id: morning
            sequence:
              - service: climate.set_temperature
                target:
                  entity_id: climate.living_room
                data:
                  hvac_mode: heat
                  temperature: 21
              - service: notify.mobile_app
                data:
                  title: "Climate Adjustment"
                  message: >
                    Cold day expected (low {{ today_low }}°C). Pre-heating house.

          # Temperature drop coming - boost heating
          - conditions:
              - condition: template
                value_template: "{{ (indoor_temp - avg_temp) > 5 }}"
            sequence:
              - service: climate.set_temperature
                target:
                  entity_id: climate.living_room
                data:
                  hvac_mode: heat
                  temperature: "{{ indoor_temp | float + 1 }}"

# ============================================================
# EXAMPLE 3: UV Protection
# ============================================================
# Closes blinds during high UV periods

  - id: weather_uv_protection
    alias: "Weather: UV Protection"
    description: "Automatically closes blinds during high UV"
    mode: single

    trigger:
      - platform: time_pattern
        hours: "/1"  # Check every hour during daytime

    condition:
      - condition: sun
        after: sunrise
        after_offset: "01:00:00"
      - condition: sun
        before: sunset
        before_offset: "01:00:00"

    action:
      # Get current weather data
      - variables:
          uv_index: "{{ state_attr('weather.home', 'uv_index') | float(0) }}"
          cloud_coverage: "{{ state_attr('weather.home', 'cloud_coverage') | float(100) }}"

      # Determine protection level
      - choose:
          # Very high UV (8+) - full protection
          - conditions:
              - condition: template
                value_template: "{{ uv_index >= 8 }}"
            sequence:
              - service: cover.set_cover_position
                target:
                  entity_id:
                    - cover.living_room_blinds
                    - cover.bedroom_blinds
                data:
                  position: 10  # Almost closed

          # High UV (6-8) - partial protection
          - conditions:
              - condition: template
                value_template: "{{ uv_index >= 6 }}"
            sequence:
              - service: cover.set_cover_position
                target:
                  entity_id:
                    - cover.living_room_blinds
                    - cover.bedroom_blinds
                data:
                  position: 40

          # Moderate UV (3-6) - light protection on clear days
          - conditions:
              - condition: template
                value_template: "{{ uv_index >= 3 and cloud_coverage < 30 }}"
            sequence:
              - service: cover.set_cover_position
                target:
                  entity_id:
                    - cover.living_room_blinds
                data:
                  position: 60

# ============================================================
# EXAMPLE 4: Storm Warning Automation
# ============================================================
# Comprehensive storm preparation

  - id: weather_storm_warning
    alias: "Weather: Storm Warning"
    description: "Prepares home for incoming storms"
    mode: single

    trigger:
      - platform: time_pattern
        minutes: "/15"

    action:
      # Get forecast
      - service: weather.get_forecasts
        target:
          entity_id: weather.home
        data:
          type: hourly
        response_variable: forecast

      - variables:
          storm_conditions:
            - lightning
            - lightning-rainy
            - hail
            - exceptional

          # Check for storms in next 6 hours
          storm_forecast: >
            {% set hours = forecast['weather.home'].forecast[:6] %}
            {% set ns = namespace(storm=false, time=none, condition=none) %}
            {% for hour in hours %}
              {% if hour.condition in storm_conditions %}
                {% if not ns.storm %}
                  {% set ns.storm = true %}
                  {% set ns.time = hour.datetime %}
                  {% set ns.condition = hour.condition %}
                {% endif %}
              {% endif %}
            {% endfor %}
            {{ {'storm': ns.storm, 'time': ns.time, 'condition': ns.condition} }}

          # Check for high winds
          high_wind: >
            {% set hours = forecast['weather.home'].forecast[:6] %}
            {% set ns = namespace(high=false, speed=0) %}
            {% for hour in hours %}
              {% if hour.wind_speed | float(0) > 50 %}
                {% set ns.high = true %}
                {% if hour.wind_speed > ns.speed %}
                  {% set ns.speed = hour.wind_speed %}
                {% endif %}
              {% endif %}
            {% endfor %}
            {{ {'high': ns.high, 'max_speed': ns.speed} }}

      - if:
          - condition: template
            value_template: "{{ storm_forecast.storm or high_wind.high }}"
          - condition: state
            entity_id: input_boolean.storm_prepared
            state: "off"
        then:
          # Execute storm preparation
          - parallel:
              # Close all covers
              - service: cover.close_cover
                target:
                  entity_id: all

              # Secure outdoor devices
              - service: switch.turn_off
                target:
                  entity_id:
                    - switch.outdoor_lights
                    - switch.fountain

              # Send warning notification
              - service: notify.mobile_app
                data:
                  title: "Storm Warning"
                  message: >
                    {% if storm_forecast.storm %}
                      {{ storm_forecast.condition | title }} expected at
                      {{ as_timestamp(storm_forecast.time) | timestamp_custom('%H:%M') }}.
                    {% endif %}
                    {% if high_wind.high %}
                      High winds up to {{ high_wind.max_speed }} km/h expected.
                    {% endif %}
                    Securing outdoor equipment.
                  data:
                    tag: weather-storm
                    importance: high
                    channel: alerts

          # Mark as prepared
          - service: input_boolean.turn_on
            target:
              entity_id: input_boolean.storm_prepared

# ============================================================
# EXAMPLE 5: Frost Warning for Plants
# ============================================================
# Protects outdoor plants from frost

  - id: weather_frost_warning
    alias: "Weather: Frost Warning"
    description: "Warns about frost for plant protection"
    mode: single

    trigger:
      - platform: time
        at: "18:00:00"  # Evening check

    action:
      - service: weather.get_forecasts
        target:
          entity_id: weather.home
        data:
          type: hourly
        response_variable: forecast

      - variables:
          # Check for freezing temperatures tonight
          frost_risk: >
            {% set hours = forecast['weather.home'].forecast[:12] %}
            {% set ns = namespace(frost=false, min_temp=100) %}
            {% for hour in hours %}
              {% set temp = hour.temperature | float(10) %}
              {% if temp < ns.min_temp %}
                {% set ns.min_temp = temp %}
              {% endif %}
              {% if temp <= 2 %}
                {% set ns.frost = true %}
              {% endif %}
            {% endfor %}
            {{ {'frost': ns.frost, 'min_temp': ns.min_temp} }}

      - if:
          - condition: template
            value_template: "{{ frost_risk.frost }}"
        then:
          - service: notify.mobile_app
            data:
              title: "Frost Warning"
              message: >
                Temperature dropping to {{ frost_risk.min_temp }}°C tonight.
                Protect sensitive plants!
              data:
                tag: weather-frost
                importance: high
                actions:
                  - action: "FROST_ACKNOWLEDGE"
                    title: "Acknowledged"

# ============================================================
# SUPPORTING ENTITIES
# ============================================================

input_boolean:
  rain_prepared:
    name: "Rain Prepared"
    icon: mdi:weather-rainy

  storm_prepared:
    name: "Storm Prepared"
    icon: mdi:weather-lightning

# Reset preparation flags when weather clears
automation:
  - id: weather_reset_flags
    alias: "Weather: Reset Preparation Flags"
    trigger:
      - platform: state
        entity_id: weather.home
        to:
          - sunny
          - clear-night
          - partlycloudy
        for:
          hours: 2
    action:
      - service: input_boolean.turn_off
        target:
          entity_id:
            - input_boolean.rain_prepared
            - input_boolean.storm_prepared
