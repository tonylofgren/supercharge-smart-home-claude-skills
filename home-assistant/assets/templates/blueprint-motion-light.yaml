# Motion-Activated Light Blueprint Template
# Generated by ha-yaml@aurora-smart-home v1.0.0
# https://github.com/tonylofgren/aurora-smart-home
#
# Save this file to: config/blueprints/automation/motion_light.yaml
# Then use via Settings > Automations > Create Automation > Use Blueprint

blueprint:
  name: Motion-Activated Light
  description: >
    Turn on a light when motion is detected.
    Includes options for time-based brightness, illuminance threshold,
    and configurable timeout.
  domain: automation

  input:
    motion_entity:
      name: Motion Sensor
      description: The motion sensor that triggers the light
      selector:
        entity:
          domain: binary_sensor
          device_class: motion

    light_target:
      name: Light
      description: The light(s) to control
      selector:
        target:
          entity:
            domain: light

    no_motion_wait:
      name: Wait Time
      description: Time to leave the light on after motion stops
      default: 300
      selector:
        number:
          min: 0
          max: 3600
          unit_of_measurement: seconds

    illuminance_sensor:
      name: Illuminance Sensor (Optional)
      description: Only turn on light when illuminance is below threshold
      default: []
      selector:
        entity:
          domain: sensor
          device_class: illuminance

    illuminance_threshold:
      name: Illuminance Threshold
      description: Light turns on when illuminance is below this value
      default: 100
      selector:
        number:
          min: 0
          max: 1000
          unit_of_measurement: lx

    brightness_day:
      name: Daytime Brightness
      description: Brightness during day (8:00-20:00)
      default: 100
      selector:
        number:
          min: 1
          max: 100
          unit_of_measurement: "%"

    brightness_night:
      name: Nighttime Brightness
      description: Brightness during night (20:00-8:00)
      default: 30
      selector:
        number:
          min: 1
          max: 100
          unit_of_measurement: "%"

    time_start:
      name: Start Time (Optional)
      description: Only run after this time
      default: "00:00:00"
      selector:
        time:

    time_end:
      name: End Time (Optional)
      description: Only run before this time
      default: "23:59:59"
      selector:
        time:

# Variables for use in automation
variables:
  illuminance_sensor: !input illuminance_sensor
  illuminance_threshold: !input illuminance_threshold
  brightness_day: !input brightness_day
  brightness_night: !input brightness_night

mode: restart
max_exceeded: silent

trigger:
  - platform: state
    entity_id: !input motion_entity
    to: "on"

condition:
  # Time condition
  - condition: time
    after: !input time_start
    before: !input time_end

  # Illuminance condition (if sensor provided)
  - condition: template
    value_template: >
      {% if illuminance_sensor %}
        {{ states(illuminance_sensor) | float(0) < illuminance_threshold }}
      {% else %}
        true
      {% endif %}

action:
  # Calculate brightness based on time
  - variables:
      current_brightness: >
        {% set hour = now().hour %}
        {% if hour >= 8 and hour < 20 %}
          {{ brightness_day }}
        {% else %}
          {{ brightness_night }}
        {% endif %}

  # Turn on light
  - service: light.turn_on
    target: !input light_target
    data:
      brightness_pct: "{{ current_brightness }}"
      transition: 1

  # Wait for motion to stop
  - wait_for_trigger:
      - platform: state
        entity_id: !input motion_entity
        to: "off"
    timeout:
      hours: 1

  # Wait additional time
  - delay:
      seconds: !input no_motion_wait

  # Turn off light
  - service: light.turn_off
    target: !input light_target
    data:
      transition: 3
