# Generated by ha-yaml@aurora-smart-home v1.0.0
# https://github.com/tonylofgren/aurora-smart-home
#
# Energy Monitoring Dashboard Template
# Modern dashboard layout for energy monitoring with Tile cards
#
# Features:
# - Real-time power monitoring
# - Historical energy graphs
# - Cost tracking
# - Solar production (optional)
# - Device consumption breakdown

# ============================================================
# DASHBOARD VIEW CONFIGURATION
# ============================================================

title: Energy Monitoring
path: energy
icon: mdi:lightning-bolt

# Using sections layout (Home Assistant 2024+)
type: sections

sections:
  # ============================================================
  # SECTION 1: Current Status Overview
  # ============================================================
  - type: grid
    title: Current Status
    cards:
      # Main power consumption tile
      - type: tile
        entity: sensor.power_consumption
        name: Power Usage
        icon: mdi:flash
        color: amber
        tap_action:
          action: more-info
        features:
          - type: "numeric-input"

      # Grid import/export
      - type: tile
        entity: sensor.grid_power
        name: Grid
        icon: mdi:transmission-tower
        color: >
          {% if states('sensor.grid_power') | float > 0 %}
            red
          {% else %}
            green
          {% endif %}

      # Solar production (if available)
      - type: tile
        entity: sensor.solar_production
        name: Solar
        icon: mdi:solar-power
        color: yellow

      # Battery status (if available)
      - type: tile
        entity: sensor.home_battery
        name: Battery
        icon: mdi:battery
        color: blue

      # Current electricity price
      - type: tile
        entity: sensor.electricity_price
        name: Price Now
        icon: mdi:currency-usd
        color: >
          {% set price = states('sensor.electricity_price') | float %}
          {% set avg = state_attr('sensor.electricity_price', 'average') | float %}
          {% if price < avg * 0.7 %}
            green
          {% elif price > avg * 1.3 %}
            red
          {% else %}
            amber
          {% endif %}

      # Today's cost
      - type: tile
        entity: sensor.energy_cost_today
        name: Cost Today
        icon: mdi:cash-multiple
        color: primary

  # ============================================================
  # SECTION 2: Power Flow Visualization
  # ============================================================
  - type: grid
    title: Power Flow
    cards:
      # Energy flow card (if power-flow-card installed)
      - type: custom:power-flow-card-plus
        entities:
          grid:
            entity: sensor.grid_power
          solar:
            entity: sensor.solar_production
          battery:
            entity: sensor.home_battery
            state_of_charge: sensor.battery_soc
          home:
            entity: sensor.power_consumption

      # Or use a simple gauge if custom card not available
      - type: gauge
        entity: sensor.power_consumption
        name: Current Power
        min: 0
        max: 10000
        needle: true
        segments:
          - from: 0
            color: green
          - from: 3000
            color: yellow
          - from: 6000
            color: orange
          - from: 8000
            color: red

      # Grid direction indicator
      - type: entity
        entity: sensor.grid_power
        name: Grid Flow
        icon: >
          {% if states('sensor.grid_power') | float > 0 %}
            mdi:home-import-outline
          {% else %}
            mdi:home-export-outline
          {% endif %}

  # ============================================================
  # SECTION 3: Energy History
  # ============================================================
  - type: grid
    title: Energy History
    column_span: 2
    cards:
      # 24-hour consumption graph
      - type: statistics-graph
        title: Power Usage (24h)
        entities:
          - sensor.power_consumption
        stat_types:
          - mean
          - max
        days_to_show: 1
        period: hour

      # Daily energy consumption
      - type: statistics-graph
        title: Daily Energy
        entities:
          - sensor.daily_energy_consumption
        stat_types:
          - sum
        days_to_show: 7
        period: day

      # Cost comparison
      - type: history-graph
        title: Electricity Price (Today)
        entities:
          - entity: sensor.electricity_price
            name: Price
        hours_to_show: 24

  # ============================================================
  # SECTION 4: Device Consumption Breakdown
  # ============================================================
  - type: grid
    title: Device Consumption
    cards:
      # Major appliances
      - type: tile
        entity: sensor.hvac_power
        name: HVAC
        icon: mdi:hvac
        color: cyan

      - type: tile
        entity: sensor.water_heater_power
        name: Water Heater
        icon: mdi:water-boiler
        color: orange

      - type: tile
        entity: sensor.ev_charger_power
        name: EV Charger
        icon: mdi:ev-station
        color: green

      - type: tile
        entity: sensor.dryer_power
        name: Dryer
        icon: mdi:tumble-dryer
        color: amber

      - type: tile
        entity: sensor.washing_machine_power
        name: Washer
        icon: mdi:washing-machine
        color: blue

      - type: tile
        entity: sensor.dishwasher_power
        name: Dishwasher
        icon: mdi:dishwasher
        color: teal

      # Pie chart of consumption (requires custom card)
      - type: custom:apexcharts-card
        chart_type: donut
        header:
          show: true
          title: Power Distribution
        series:
          - entity: sensor.hvac_power
            name: HVAC
          - entity: sensor.water_heater_power
            name: Water Heater
          - entity: sensor.ev_charger_power
            name: EV Charger
          - entity: sensor.other_power
            name: Other

  # ============================================================
  # SECTION 5: Solar Production (if applicable)
  # ============================================================
  - type: grid
    title: Solar Production
    cards:
      # Solar production today
      - type: tile
        entity: sensor.solar_energy_today
        name: Solar Today
        icon: mdi:solar-power-variant
        color: yellow

      # Self-consumption rate
      - type: tile
        entity: sensor.self_consumption_rate
        name: Self Use
        icon: mdi:percent
        color: green

      # Solar production graph
      - type: statistics-graph
        title: Solar Production
        entities:
          - sensor.solar_production
        stat_types:
          - mean
          - max
        days_to_show: 1
        period: hour

  # ============================================================
  # SECTION 6: Cost Analysis
  # ============================================================
  - type: grid
    title: Cost Analysis
    cards:
      # Today's cost
      - type: entity
        entity: sensor.energy_cost_today
        name: Today
        icon: mdi:currency-usd

      # This week's cost
      - type: entity
        entity: sensor.energy_cost_week
        name: This Week
        icon: mdi:calendar-week

      # This month's cost
      - type: entity
        entity: sensor.energy_cost_month
        name: This Month
        icon: mdi:calendar-month

      # Savings from solar
      - type: entity
        entity: sensor.solar_savings_today
        name: Solar Savings
        icon: mdi:piggy-bank
        color: green

      # Price forecast
      - type: custom:apexcharts-card
        header:
          show: true
          title: Price Forecast
        graph_span: 24h
        series:
          - entity: sensor.electricity_price
            data_generator: |
              return entity.attributes.raw_today.map((d) => {
                return [new Date(d.start).getTime(), d.value];
              });

  # ============================================================
  # SECTION 7: Controls and Optimization
  # ============================================================
  - type: grid
    title: Energy Controls
    cards:
      # Peak avoidance toggle
      - type: tile
        entity: input_boolean.peak_avoidance_mode
        name: Peak Avoidance
        icon: mdi:flash-off
        color: orange
        tap_action:
          action: toggle

      # Solar priority mode
      - type: tile
        entity: input_boolean.solar_priority_mode
        name: Solar Priority
        icon: mdi:solar-power
        color: yellow
        tap_action:
          action: toggle

      # EV smart charging
      - type: tile
        entity: input_boolean.ev_smart_charging
        name: Smart EV Charging
        icon: mdi:ev-plug-type2
        color: green
        tap_action:
          action: toggle

      # Price threshold slider
      - type: tile
        entity: input_number.price_threshold
        name: Price Threshold
        icon: mdi:currency-usd-off
        features:
          - type: "numeric-input"
            mode: slider

      # Pending appliances
      - type: tile
        entity: input_boolean.pending_washing_machine
        name: Queue Washer
        icon: mdi:washing-machine
        tap_action:
          action: toggle

      - type: tile
        entity: input_boolean.pending_dishwasher
        name: Queue Dishwasher
        icon: mdi:dishwasher
        tap_action:
          action: toggle

# ============================================================
# TEMPLATE SENSORS FOR DASHBOARD
# ============================================================
# Add these to your configuration.yaml or templates.yaml

template:
  - sensor:
      # Self-consumption rate
      - name: "Self Consumption Rate"
        unit_of_measurement: "%"
        state: >
          {% set solar = states('sensor.solar_production') | float(0) %}
          {% set export = states('sensor.grid_export') | float(0) %}
          {% if solar > 0 %}
            {{ ((solar - export) / solar * 100) | round(0) }}
          {% else %}
            0
          {% endif %}

      # "Other" power (total minus known devices)
      - name: "Other Power"
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        state: >
          {% set total = states('sensor.power_consumption') | float(0) %}
          {% set hvac = states('sensor.hvac_power') | float(0) %}
          {% set water = states('sensor.water_heater_power') | float(0) %}
          {% set ev = states('sensor.ev_charger_power') | float(0) %}
          {% set dryer = states('sensor.dryer_power') | float(0) %}
          {% set washer = states('sensor.washing_machine_power') | float(0) %}
          {% set dishwasher = states('sensor.dishwasher_power') | float(0) %}
          {{ [0, total - hvac - water - ev - dryer - washer - dishwasher] | max | round(0) }}

      # Weekly energy cost
      - name: "Energy Cost Week"
        unit_of_measurement: "SEK"
        device_class: monetary
        state: >
          {{ states('sensor.weekly_energy_consumption') | float(0) *
             state_attr('sensor.electricity_price', 'average') | float(1) }}

      # Monthly energy cost
      - name: "Energy Cost Month"
        unit_of_measurement: "SEK"
        device_class: monetary
        state: >
          {{ states('sensor.monthly_energy_consumption') | float(0) *
             state_attr('sensor.electricity_price', 'average') | float(1) }}

      # Solar savings today
      - name: "Solar Savings Today"
        unit_of_measurement: "SEK"
        device_class: monetary
        state: >
          {% set solar_consumed = states('sensor.solar_self_consumed_today') | float(0) %}
          {% set avg_price = state_attr('sensor.electricity_price', 'average') | float(1) %}
          {{ (solar_consumed * avg_price) | round(2) }}

# ============================================================
# UTILITY METERS FOR TRACKING
# ============================================================

utility_meter:
  daily_energy_consumption:
    source: sensor.energy_consumption
    cycle: daily

  weekly_energy_consumption:
    source: sensor.energy_consumption
    cycle: weekly

  monthly_energy_consumption:
    source: sensor.energy_consumption
    cycle: monthly

  daily_solar_production:
    source: sensor.solar_production_total
    cycle: daily

# ============================================================
# INPUT ENTITIES FOR CONTROLS
# ============================================================

input_boolean:
  peak_avoidance_mode:
    name: "Peak Avoidance Mode"
    icon: mdi:flash-off

  solar_priority_mode:
    name: "Solar Priority Mode"
    icon: mdi:solar-power

  ev_smart_charging:
    name: "Smart EV Charging"
    icon: mdi:ev-plug-type2

  pending_washing_machine:
    name: "Washing Machine Queued"
    icon: mdi:washing-machine

  pending_dishwasher:
    name: "Dishwasher Queued"
    icon: mdi:dishwasher

input_number:
  price_threshold:
    name: "Price Threshold"
    min: 0.5
    max: 5.0
    step: 0.1
    unit_of_measurement: "SEK/kWh"
    icon: mdi:currency-usd
