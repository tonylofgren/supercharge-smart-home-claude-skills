# Generated by ha-yaml@aurora-smart-home v1.0.0
# https://github.com/tonylofgren/aurora-smart-home
#
# Rate Limiting Script Template
# Demonstrates rate-limited actions using counters, timers, and conditions
#
# Features:
# - Counter-based rate limiting
# - Time-window rate limiting
# - Cooldown period enforcement
# - Burst protection

# ============================================================
# EXAMPLE 1: Simple Rate Limited Notification
# ============================================================
# Limits notifications to once per configurable interval

script:
  rate_limited_notification:
    alias: "Rate Limited Notification"
    description: "Sends notification with rate limiting"
    mode: single
    max_exceeded: silent  # Silently ignore if already running

    fields:
      title:
        description: "Notification title"
        example: "Alert"
        required: true
        selector:
          text:
      message:
        description: "Notification message"
        example: "Something happened"
        required: true
        selector:
          text:
      tag:
        description: "Unique tag for rate limiting"
        example: "motion_alert"
        required: true
        selector:
          text:
      cooldown_minutes:
        description: "Minimum minutes between notifications"
        example: 5
        default: 5
        selector:
          number:
            min: 1
            max: 60

    variables:
      last_sent_entity: "input_datetime.last_notification_{{ tag }}"
      cooldown_seconds: "{{ (cooldown_minutes | default(5)) * 60 }}"

    sequence:
      # Check if enough time has passed
      - condition: template
        value_template: >
          {% set last_sent = states(last_sent_entity) %}
          {% if last_sent in ['unknown', 'unavailable'] %}
            true
          {% else %}
            {% set last_ts = as_timestamp(last_sent) %}
            {% set now_ts = as_timestamp(now()) %}
            {{ (now_ts - last_ts) > cooldown_seconds }}
          {% endif %}

      # Send notification
      - service: notify.mobile_app
        data:
          title: "{{ title }}"
          message: "{{ message }}"
          data:
            tag: "{{ tag }}"

      # Update last sent time
      - service: input_datetime.set_datetime
        target:
          entity_id: "{{ last_sent_entity }}"
        data:
          datetime: "{{ now().isoformat() }}"

# ============================================================
# EXAMPLE 2: Counter-Based Rate Limiting
# ============================================================
# Allows N actions per time window

  rate_limited_action:
    alias: "Rate Limited Action (Counter)"
    description: "Limits actions to N per hour"
    mode: queued
    max: 5

    fields:
      action_type:
        description: "Type of action for tracking"
        example: "door_lock"
        required: true
        selector:
          text:
      max_per_hour:
        description: "Maximum allowed actions per hour"
        example: 5
        default: 5
        selector:
          number:
            min: 1
            max: 100

    variables:
      counter_entity: "counter.{{ action_type }}_rate_limit"
      max_actions: "{{ max_per_hour | default(5) }}"

    sequence:
      # Check counter
      - condition: template
        value_template: >
          {{ states(counter_entity) | int(0) < max_actions | int }}

      # Increment counter
      - service: counter.increment
        target:
          entity_id: "{{ counter_entity }}"

      # Execute the actual action (placeholder - customize as needed)
      - event: rate_limited_action_executed
        event_data:
          action_type: "{{ action_type }}"
          count: "{{ states(counter_entity) }}"

# ============================================================
# EXAMPLE 3: Doorbell Rate Limiting
# ============================================================
# Practical example: rate limit doorbell notifications

  doorbell_notification:
    alias: "Doorbell Notification (Rate Limited)"
    description: "Notifies about doorbell with anti-spam"
    mode: single
    max_exceeded: silent

    sequence:
      # Check cooldown (30 seconds minimum between rings)
      - condition: template
        value_template: >
          {% set last = states('input_datetime.last_doorbell') %}
          {% if last in ['unknown', 'unavailable'] %}
            true
          {% else %}
            {{ (as_timestamp(now()) - as_timestamp(last)) > 30 }}
          {% endif %}

      # Check burst limit (max 5 per 10 minutes)
      - condition: template
        value_template: >
          {{ states('counter.doorbell_rings') | int(0) < 5 }}

      # Update tracking
      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.last_doorbell
        data:
          datetime: "{{ now().isoformat() }}"

      - service: counter.increment
        target:
          entity_id: counter.doorbell_rings

      # Send notification with camera snapshot
      - service: notify.mobile_app
        data:
          title: "Doorbell"
          message: "Someone is at the door"
          data:
            tag: doorbell
            importance: high
            image: /api/camera_proxy/camera.front_door
            actions:
              - action: UNLOCK_DOOR
                title: "Unlock Door"
              - action: IGNORE
                title: "Ignore"

      # Optional: Play announcement on speakers
      - service: tts.speak
        target:
          entity_id: tts.piper
        data:
          media_player_entity_id: media_player.living_room
          message: "Someone is at the front door"

# ============================================================
# EXAMPLE 4: Motion Alert with Escalation
# ============================================================
# Rate limits but escalates if activity continues

  motion_alert_escalating:
    alias: "Motion Alert (Escalating)"
    description: "Alerts about motion with escalation"
    mode: single
    max_exceeded: silent

    fields:
      area:
        description: "Area where motion detected"
        example: "Backyard"
        required: true
        selector:
          text:

    sequence:
      - variables:
          alert_count: "{{ states('counter.motion_alerts_' ~ area | lower | replace(' ', '_')) | int(0) }}"
          alert_level: >
            {% if alert_count == 0 %}
              normal
            {% elif alert_count < 3 %}
              elevated
            {% else %}
              high
            {% endif %}

      # Different cooldowns based on level
      - variables:
          cooldown: >
            {% if alert_level == 'normal' %}
              60
            {% elif alert_level == 'elevated' %}
              30
            {% else %}
              15
            {% endif %}

      # Check cooldown
      - condition: template
        value_template: >
          {% set last = states('input_datetime.last_motion_' ~ area | lower | replace(' ', '_')) %}
          {% if last in ['unknown', 'unavailable'] %}
            true
          {% else %}
            {{ (as_timestamp(now()) - as_timestamp(last)) > cooldown }}
          {% endif %}

      # Update tracking
      - service: input_datetime.set_datetime
        target:
          entity_id: "input_datetime.last_motion_{{ area | lower | replace(' ', '_') }}"
        data:
          datetime: "{{ now().isoformat() }}"

      - service: counter.increment
        target:
          entity_id: "counter.motion_alerts_{{ area | lower | replace(' ', '_') }}"

      # Send appropriate alert
      - choose:
          # First alert - normal notification
          - conditions: "{{ alert_level == 'normal' }}"
            sequence:
              - service: notify.mobile_app
                data:
                  title: "Motion: {{ area }}"
                  message: "Motion detected in {{ area }}"
                  data:
                    tag: "motion-{{ area | lower | replace(' ', '_') }}"

          # Repeated alerts - elevated
          - conditions: "{{ alert_level == 'elevated' }}"
            sequence:
              - service: notify.mobile_app
                data:
                  title: "Repeated Motion: {{ area }}"
                  message: "{{ alert_count + 1 }} motion events in {{ area }}"
                  data:
                    tag: "motion-{{ area | lower | replace(' ', '_') }}"
                    importance: high

          # Many alerts - high priority
          - conditions: "{{ alert_level == 'high' }}"
            sequence:
              - service: notify.mobile_app
                data:
                  title: "Continuous Motion: {{ area }}"
                  message: "Ongoing activity in {{ area }} ({{ alert_count + 1 }} events)"
                  data:
                    tag: "motion-{{ area | lower | replace(' ', '_') }}"
                    importance: high
                    channel: urgent
                    actions:
                      - action: VIEW_CAMERA
                        title: "View Camera"
                      - action: SILENCE_AREA
                        title: "Silence {{ area }}"

# ============================================================
# EXAMPLE 5: API Call Rate Limiter
# ============================================================
# For external API calls with strict limits

  api_call_rate_limited:
    alias: "API Call (Rate Limited)"
    description: "Makes API call with rate limiting"
    mode: queued
    max: 3

    fields:
      api_name:
        description: "Name of API for tracking"
        example: "weather_api"
        required: true
        selector:
          text:
      calls_per_minute:
        description: "Max calls per minute"
        example: 10
        default: 10
        selector:
          number:
            min: 1
            max: 60

    sequence:
      # Check minute window
      - condition: template
        value_template: >
          {% set counter = 'counter.' ~ api_name ~ '_calls' %}
          {{ states(counter) | int(0) < calls_per_minute | int }}

      # Calculate time until next window reset
      - variables:
          window_start: >
            {{ states('input_datetime.' ~ api_name ~ '_window_start') }}
          seconds_elapsed: >
            {% if window_start in ['unknown', 'unavailable'] %}
              999
            {% else %}
              {{ (as_timestamp(now()) - as_timestamp(window_start)) | int }}
            {% endif %}

      # Reset window if minute has passed
      - if:
          - condition: template
            value_template: "{{ seconds_elapsed >= 60 }}"
        then:
          - service: counter.reset
            target:
              entity_id: "counter.{{ api_name }}_calls"
          - service: input_datetime.set_datetime
            target:
              entity_id: "input_datetime.{{ api_name }}_window_start"
            data:
              datetime: "{{ now().isoformat() }}"

      # Increment call counter
      - service: counter.increment
        target:
          entity_id: "counter.{{ api_name }}_calls"

      # Fire event to signal API call is allowed
      # (Actual API call would be implemented by caller)
      - event: api_call_permitted
        event_data:
          api_name: "{{ api_name }}"
          calls_remaining: >
            {{ calls_per_minute | int - states('counter.' ~ api_name ~ '_calls') | int }}

# ============================================================
# SUPPORTING ENTITIES
# ============================================================
# These need to be created for each rate-limited action type

input_datetime:
  last_doorbell:
    name: "Last Doorbell Ring"
    has_date: true
    has_time: true

  last_motion_backyard:
    name: "Last Motion - Backyard"
    has_date: true
    has_time: true

  last_motion_front_yard:
    name: "Last Motion - Front Yard"
    has_date: true
    has_time: true

  weather_api_window_start:
    name: "Weather API Window Start"
    has_date: true
    has_time: true

counter:
  doorbell_rings:
    name: "Doorbell Rings"
    initial: 0
    step: 1
    icon: mdi:bell-ring

  motion_alerts_backyard:
    name: "Motion Alerts - Backyard"
    initial: 0
    step: 1
    icon: mdi:motion-sensor

  motion_alerts_front_yard:
    name: "Motion Alerts - Front Yard"
    initial: 0
    step: 1
    icon: mdi:motion-sensor

  weather_api_calls:
    name: "Weather API Calls"
    initial: 0
    step: 1
    icon: mdi:api

# Reset counters periodically
automation:
  - id: rate_limit_counter_reset
    alias: "Rate Limit: Reset Counters"
    description: "Resets rate limit counters every 10 minutes"
    trigger:
      - platform: time_pattern
        minutes: "/10"
    action:
      - service: counter.reset
        target:
          entity_id:
            - counter.doorbell_rings
            - counter.motion_alerts_backyard
            - counter.motion_alerts_front_yard

  - id: rate_limit_daily_reset
    alias: "Rate Limit: Daily Reset"
    description: "Resets all rate limit counters at midnight"
    trigger:
      - platform: time
        at: "00:00:00"
    action:
      - service: counter.reset
        target:
          entity_id: all
