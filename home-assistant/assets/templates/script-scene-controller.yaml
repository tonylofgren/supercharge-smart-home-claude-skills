# Scene Controller Script Template
# Generated by ha-yaml@aurora-smart-home v1.0.0
# https://github.com/tonylofgren/aurora-smart-home
#
# Advanced scene scripts with transitions, conditional behavior,
# and device-specific handling.

# =====================================================
# REQUIRED HELPERS
# =====================================================

input_select:
  current_scene:
    name: "Current Scene"
    options:
      - Morning
      - Day
      - Evening
      - Movie
      - Romantic
      - Night
      - Away
      - "Off"
    icon: mdi:palette

input_number:
  scene_transition_time:
    name: "Scene Transition Time"
    min: 0
    max: 30
    step: 1
    unit_of_measurement: "s"
    icon: mdi:timer
    initial: 3

# =====================================================
# MAIN SCENE CONTROLLER SCRIPT
# =====================================================

script:
  # Master scene controller with smooth transitions
  activate_scene:
    alias: "Activate Scene"
    description: "Master scene controller with transitions"
    fields:
      scene_name:
        description: "Name of the scene to activate"
        example: "Evening"
        selector:
          select:
            options:
              - Morning
              - Day
              - Evening
              - Movie
              - Romantic
              - Night
              - Away
              - "Off"
      transition:
        description: "Transition time in seconds"
        example: 3
        selector:
          number:
            min: 0
            max: 30
      force:
        description: "Force scene even if already active"
        example: false
        selector:
          boolean:
    sequence:
      # Check if scene is already active (unless forced)
      - condition: template
        value_template: >
          {{ force | default(false) or
             states('input_select.current_scene') != scene_name }}

      # Store previous scene for potential undo
      - service: input_text.set_value
        target:
          entity_id: input_text.previous_scene
        data:
          value: "{{ states('input_select.current_scene') }}"

      # Update current scene
      - service: input_select.select_option
        target:
          entity_id: input_select.current_scene
        data:
          option: "{{ scene_name }}"

      # Get transition time
      - variables:
          trans: "{{ transition | default(states('input_number.scene_transition_time') | int) }}"

      # Route to specific scene script
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ scene_name == 'Morning' }}"
            sequence:
              - service: script.scene_morning
                data:
                  transition: "{{ trans }}"

          - conditions:
              - condition: template
                value_template: "{{ scene_name == 'Day' }}"
            sequence:
              - service: script.scene_day
                data:
                  transition: "{{ trans }}"

          - conditions:
              - condition: template
                value_template: "{{ scene_name == 'Evening' }}"
            sequence:
              - service: script.scene_evening
                data:
                  transition: "{{ trans }}"

          - conditions:
              - condition: template
                value_template: "{{ scene_name == 'Movie' }}"
            sequence:
              - service: script.scene_movie
                data:
                  transition: "{{ trans }}"

          - conditions:
              - condition: template
                value_template: "{{ scene_name == 'Romantic' }}"
            sequence:
              - service: script.scene_romantic
                data:
                  transition: "{{ trans }}"

          - conditions:
              - condition: template
                value_template: "{{ scene_name == 'Night' }}"
            sequence:
              - service: script.scene_night
                data:
                  transition: "{{ trans }}"

          - conditions:
              - condition: template
                value_template: "{{ scene_name == 'Away' }}"
            sequence:
              - service: script.scene_away
                data:
                  transition: "{{ trans }}"

          - conditions:
              - condition: template
                value_template: "{{ scene_name == 'Off' }}"
            sequence:
              - service: script.scene_off
                data:
                  transition: "{{ trans }}"

  # =====================================================
  # INDIVIDUAL SCENE SCRIPTS
  # =====================================================

  scene_morning:
    alias: "Scene: Morning"
    fields:
      transition:
        description: "Transition time"
        default: 5
    sequence:
      # Gradual wake-up lighting
      - service: light.turn_on
        target:
          entity_id:
            - light.bedroom
            - light.bathroom
        data:
          brightness_pct: 30
          kelvin: 2700
          transition: "{{ transition }}"

      # Ramp up brightness over time
      - delay:
          seconds: "{{ (transition | int) * 2 }}"

      - service: light.turn_on
        target:
          entity_id:
            - light.bedroom
            - light.bathroom
        data:
          brightness_pct: 80
          kelvin: 4000
          transition: "{{ transition }}"

      # Open blinds slowly
      - service: cover.set_cover_position
        target:
          entity_id: cover.bedroom_blinds
        data:
          position: 50

      - delay:
          seconds: "{{ transition }}"

      - service: cover.open_cover
        target:
          entity_id: cover.bedroom_blinds

      # Set comfortable temperature
      - service: climate.set_temperature
        target:
          entity_id: climate.home
        data:
          temperature: 21

  scene_day:
    alias: "Scene: Day"
    fields:
      transition:
        default: 3
    sequence:
      # Bright, productive lighting
      - service: light.turn_on
        target:
          entity_id:
            - light.living_room
            - light.kitchen
            - light.office
        data:
          brightness_pct: 100
          kelvin: 5000
          transition: "{{ transition }}"

      # Open all blinds
      - service: cover.open_cover
        target:
          entity_id: all

  scene_evening:
    alias: "Scene: Evening"
    fields:
      transition:
        default: 5
    sequence:
      # Warm, relaxed lighting
      - service: light.turn_on
        target:
          entity_id:
            - light.living_room
            - light.dining_room
        data:
          brightness_pct: 70
          kelvin: 3000
          transition: "{{ transition }}"

      # Accent lights on
      - service: light.turn_on
        target:
          entity_id:
            - light.living_room_accent
            - light.tv_backlight
        data:
          brightness_pct: 40
          rgb_color: [255, 180, 100]
          transition: "{{ transition }}"

      # Close blinds if sun is down
      - condition: sun
        after: sunset
      - service: cover.close_cover
        target:
          entity_id:
            - cover.living_room_blinds
            - cover.bedroom_blinds

  scene_movie:
    alias: "Scene: Movie"
    fields:
      transition:
        default: 3
    sequence:
      # Dim main lights
      - service: light.turn_off
        target:
          entity_id:
            - light.living_room
            - light.kitchen
        data:
          transition: "{{ transition }}"

      # TV backlight / bias lighting
      - service: light.turn_on
        target:
          entity_id: light.tv_backlight
        data:
          brightness_pct: 30
          rgb_color: [100, 100, 255]
          transition: "{{ transition }}"

      # Small accent light
      - service: light.turn_on
        target:
          entity_id: light.living_room_accent
        data:
          brightness_pct: 10
          kelvin: 2700
          transition: "{{ transition }}"

      # Close blinds
      - service: cover.close_cover
        target:
          entity_id: cover.living_room_blinds

      # Set media player if available
      - condition: state
        entity_id: media_player.living_room_tv
        state: "on"
      - service: media_player.select_source
        target:
          entity_id: media_player.living_room_tv
        data:
          source: "HDMI 1"

  scene_romantic:
    alias: "Scene: Romantic"
    fields:
      transition:
        default: 5
    sequence:
      # Warm, dim lighting
      - service: light.turn_on
        target:
          entity_id:
            - light.living_room
            - light.dining_room
        data:
          brightness_pct: 15
          kelvin: 2200
          transition: "{{ transition }}"

      # Colored accents
      - service: light.turn_on
        target:
          entity_id: light.living_room_accent
        data:
          brightness_pct: 30
          rgb_color: [255, 50, 100]
          transition: "{{ transition }}"

      # Turn off other lights
      - service: light.turn_off
        target:
          entity_id:
            - light.kitchen
            - light.bathroom
            - light.hallway
        data:
          transition: "{{ transition }}"

      # Close all blinds
      - service: cover.close_cover
        target:
          entity_id: all

  scene_night:
    alias: "Scene: Night"
    fields:
      transition:
        default: 10
    sequence:
      # Very dim, warm light for bathroom visits
      - service: light.turn_on
        target:
          entity_id:
            - light.hallway
            - light.bathroom
        data:
          brightness_pct: 3
          rgb_color: [255, 100, 50]
          transition: "{{ transition }}"

      # Turn off all other lights
      - service: light.turn_off
        target:
          entity_id:
            - light.living_room
            - light.kitchen
            - light.bedroom
        data:
          transition: "{{ transition }}"

      # Lower temperature
      - service: climate.set_temperature
        target:
          entity_id: climate.home
        data:
          temperature: 18

      # Make sure doors are locked
      - service: lock.lock
        target:
          entity_id: all

  scene_away:
    alias: "Scene: Away"
    fields:
      transition:
        default: 5
    sequence:
      # Turn off all lights
      - service: light.turn_off
        target:
          entity_id: all
        data:
          transition: "{{ transition }}"

      # Lower temperature
      - service: climate.set_temperature
        target:
          entity_id: climate.home
        data:
          temperature: 17

      # Close blinds
      - service: cover.close_cover
        target:
          entity_id: all

      # Lock all doors
      - service: lock.lock
        target:
          entity_id: all

      # Arm alarm if available
      - condition: state
        entity_id: alarm_control_panel.home
        state: "disarmed"
      - service: alarm_control_panel.alarm_arm_away
        target:
          entity_id: alarm_control_panel.home

  scene_off:
    alias: "Scene: Off"
    fields:
      transition:
        default: 3
    sequence:
      # Turn off all lights
      - service: light.turn_off
        target:
          entity_id: all
        data:
          transition: "{{ transition }}"

      # Turn off media players
      - service: media_player.turn_off
        target:
          entity_id: all

  # =====================================================
  # UTILITY SCRIPTS
  # =====================================================

  # Restore previous scene
  restore_previous_scene:
    alias: "Restore Previous Scene"
    sequence:
      - service: script.activate_scene
        data:
          scene_name: "{{ states('input_text.previous_scene') }}"
          transition: 2

  # Cycle through scenes
  cycle_scene:
    alias: "Cycle Scene"
    sequence:
      - variables:
          scenes:
            - Day
            - Evening
            - Night
            - "Off"
          current: "{{ states('input_select.current_scene') }}"
          current_index: "{{ scenes.index(current) if current in scenes else -1 }}"
          next_index: "{{ (current_index + 1) % (scenes | length) }}"
      - service: script.activate_scene
        data:
          scene_name: "{{ scenes[next_index] }}"

  # Adaptive scene based on time
  set_adaptive_scene:
    alias: "Set Adaptive Scene"
    sequence:
      - variables:
          hour: "{{ now().hour }}"
          scene: >
            {% if hour >= 6 and hour < 9 %}
              Morning
            {% elif hour >= 9 and hour < 18 %}
              Day
            {% elif hour >= 18 and hour < 22 %}
              Evening
            {% else %}
              Night
            {% endif %}
      - service: script.activate_scene
        data:
          scene_name: "{{ scene }}"

# =====================================================
# ADDITIONAL HELPER FOR PREVIOUS SCENE
# =====================================================

input_text:
  previous_scene:
    name: "Previous Scene"
    initial: "Off"

# =====================================================
# AUTOMATIONS FOR SCENE MANAGEMENT
# =====================================================

automation:
  # Auto-scene based on time (if enabled)
  - id: auto_scene_time_based
    alias: "Auto Scene: Time Based"
    trigger:
      - platform: time
        at: "06:30:00"
      - platform: time
        at: "09:00:00"
      - platform: time
        at: "18:00:00"
      - platform: time
        at: "22:30:00"
    condition:
      - condition: state
        entity_id: input_boolean.auto_scene_enabled
        state: "on"
      - condition: state
        entity_id: binary_sensor.anyone_home
        state: "on"
    action:
      - service: script.set_adaptive_scene

  # Scene on arriving home
  - id: scene_on_arrival
    alias: "Scene: On Arrival"
    trigger:
      - platform: state
        entity_id: binary_sensor.anyone_home
        from: "off"
        to: "on"
    action:
      - service: script.set_adaptive_scene

  # Away scene when leaving
  - id: scene_on_leaving
    alias: "Scene: On Leaving"
    trigger:
      - platform: state
        entity_id: binary_sensor.anyone_home
        from: "on"
        to: "off"
        for:
          minutes: 5
    action:
      - service: script.activate_scene
        data:
          scene_name: "Away"

# Helper for auto-scene
input_boolean:
  auto_scene_enabled:
    name: "Auto Scene Enabled"
    icon: mdi:calendar-clock

# =====================================================
# USAGE EXAMPLES
# =====================================================
#
# Call from automation or script:
#
# service: script.activate_scene
# data:
#   scene_name: "Evening"
#   transition: 5
#
# Or from UI/Lovelace button:
#
# type: button
# tap_action:
#   action: call-service
#   service: script.activate_scene
#   data:
#     scene_name: Movie
