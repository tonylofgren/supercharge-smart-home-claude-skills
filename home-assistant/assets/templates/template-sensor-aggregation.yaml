# Template Sensor Aggregation Templates
# Generated by ha-yaml@aurora-smart-home v1.0.0
# https://github.com/tonylofgren/aurora-smart-home
#
# Collection of useful aggregation sensors for common use cases

template:
  # =====================================================
  # TEMPERATURE SENSORS
  # =====================================================

  - sensor:
      # Average temperature across all rooms
      - name: "Average Indoor Temperature"
        unique_id: avg_indoor_temp
        unit_of_measurement: "Â°C"
        device_class: temperature
        state_class: measurement
        state: >
          {% set temps = states.sensor
             | selectattr('attributes.device_class', 'eq', 'temperature')
             | rejectattr('state', 'in', ['unknown', 'unavailable'])
             | rejectattr('entity_id', 'search', 'outdoor|outside')
             | map(attribute='state')
             | map('float')
             | list %}
          {{ (temps | sum / temps | length) | round(1) if temps else 'unknown' }}
        availability: >
          {{ states.sensor
             | selectattr('attributes.device_class', 'eq', 'temperature')
             | rejectattr('state', 'in', ['unknown', 'unavailable'])
             | list | length > 0 }}

      # Highest temperature room
      - name: "Warmest Room"
        unique_id: warmest_room
        state: >
          {% set temps = states.sensor
             | selectattr('attributes.device_class', 'eq', 'temperature')
             | rejectattr('state', 'in', ['unknown', 'unavailable'])
             | rejectattr('entity_id', 'search', 'outdoor|outside')
             | sort(attribute='state', reverse=true)
             | list %}
          {{ temps[0].attributes.friendly_name if temps else 'Unknown' }}
        attributes:
          temperature: >
            {% set temps = states.sensor
               | selectattr('attributes.device_class', 'eq', 'temperature')
               | rejectattr('state', 'in', ['unknown', 'unavailable'])
               | rejectattr('entity_id', 'search', 'outdoor|outside')
               | sort(attribute='state', reverse=true)
               | list %}
            {{ temps[0].state if temps else 'unknown' }}

  # =====================================================
  # POWER / ENERGY SENSORS
  # =====================================================

  - sensor:
      # Total power consumption
      - name: "Total Power Consumption"
        unique_id: total_power
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        state: >
          {{ states.sensor
             | selectattr('attributes.device_class', 'eq', 'power')
             | rejectattr('state', 'in', ['unknown', 'unavailable'])
             | map(attribute='state')
             | map('float', 0)
             | sum | round(0) }}

      # Highest power consumer
      - name: "Top Power Consumer"
        unique_id: top_power_consumer
        state: >
          {% set devices = states.sensor
             | selectattr('attributes.device_class', 'eq', 'power')
             | rejectattr('state', 'in', ['unknown', 'unavailable'])
             | sort(attribute='state', reverse=true)
             | list %}
          {{ devices[0].attributes.friendly_name if devices else 'None' }}
        attributes:
          power: >
            {% set devices = states.sensor
               | selectattr('attributes.device_class', 'eq', 'power')
               | rejectattr('state', 'in', ['unknown', 'unavailable'])
               | sort(attribute='state', reverse=true)
               | list %}
            {{ devices[0].state if devices else 0 }}

  # =====================================================
  # BATTERY SENSORS
  # =====================================================

  - sensor:
      # Lowest battery device
      - name: "Lowest Battery Device"
        unique_id: lowest_battery
        unit_of_measurement: "%"
        device_class: battery
        state: >
          {% set batteries = states.sensor
             | selectattr('attributes.device_class', 'eq', 'battery')
             | rejectattr('state', 'in', ['unknown', 'unavailable'])
             | sort(attribute='state')
             | list %}
          {{ batteries[0].state if batteries else 'unknown' }}
        attributes:
          device_name: >
            {% set batteries = states.sensor
               | selectattr('attributes.device_class', 'eq', 'battery')
               | rejectattr('state', 'in', ['unknown', 'unavailable'])
               | sort(attribute='state')
               | list %}
            {{ batteries[0].attributes.friendly_name if batteries else 'None' }}

      # Count of low batteries
      - name: "Low Battery Count"
        unique_id: low_battery_count
        state: >
          {{ states.sensor
             | selectattr('attributes.device_class', 'eq', 'battery')
             | rejectattr('state', 'in', ['unknown', 'unavailable'])
             | selectattr('state', 'lt', '20')
             | list | length }}

      # List of low battery devices
      - name: "Low Battery Devices"
        unique_id: low_battery_devices
        state: >
          {% set low = states.sensor
             | selectattr('attributes.device_class', 'eq', 'battery')
             | rejectattr('state', 'in', ['unknown', 'unavailable'])
             | selectattr('state', 'lt', '20')
             | map(attribute='attributes.friendly_name')
             | list %}
          {{ low | join(', ') if low else 'All OK' }}

  # =====================================================
  # LIGHT SENSORS
  # =====================================================

  - sensor:
      # Count of lights on
      - name: "Lights On Count"
        unique_id: lights_on_count
        state: >
          {{ states.light
             | selectattr('state', 'eq', 'on')
             | list | length }}
        attributes:
          lights: >
            {{ states.light
               | selectattr('state', 'eq', 'on')
               | map(attribute='attributes.friendly_name')
               | list }}

  # =====================================================
  # DOOR/WINDOW SENSORS
  # =====================================================

  - sensor:
      # Open doors count
      - name: "Open Doors Count"
        unique_id: open_doors_count
        state: >
          {{ states.binary_sensor
             | selectattr('attributes.device_class', 'eq', 'door')
             | selectattr('state', 'eq', 'on')
             | list | length }}

      # Open windows count
      - name: "Open Windows Count"
        unique_id: open_windows_count
        state: >
          {{ states.binary_sensor
             | selectattr('attributes.device_class', 'eq', 'window')
             | selectattr('state', 'eq', 'on')
             | list | length }}

      # Security summary
      - name: "Security Summary"
        unique_id: security_summary
        state: >
          {% set doors = states.binary_sensor
             | selectattr('attributes.device_class', 'eq', 'door')
             | selectattr('state', 'eq', 'on')
             | list | length %}
          {% set windows = states.binary_sensor
             | selectattr('attributes.device_class', 'eq', 'window')
             | selectattr('state', 'eq', 'on')
             | list | length %}
          {% set locks = states.lock
             | selectattr('state', 'eq', 'unlocked')
             | list | length %}
          {% if doors == 0 and windows == 0 and locks == 0 %}
            Secure
          {% else %}
            {{ doors }} doors, {{ windows }} windows, {{ locks }} locks open
          {% endif %}
        icon: >
          {% set secure = states.binary_sensor
             | selectattr('attributes.device_class', 'in', ['door', 'window'])
             | selectattr('state', 'eq', 'on')
             | list | length == 0 %}
          {% if secure %}
            mdi:shield-check
          {% else %}
            mdi:shield-alert
          {% endif %}

  # =====================================================
  # PRESENCE / OCCUPANCY
  # =====================================================

  - binary_sensor:
      # Anyone home (based on person entities)
      - name: "Anyone Home"
        unique_id: anyone_home
        device_class: presence
        state: >
          {{ states.person
             | selectattr('state', 'eq', 'home')
             | list | length > 0 }}

      # House occupied (presence + motion)
      - name: "House Occupied"
        unique_id: house_occupied
        device_class: occupancy
        state: >
          {{ is_state('binary_sensor.anyone_home', 'on')
             or states.binary_sensor
                | selectattr('attributes.device_class', 'eq', 'motion')
                | selectattr('state', 'eq', 'on')
                | list | length > 0 }}
        delay_off:
          minutes: 30

  - sensor:
      # People home count
      - name: "People Home Count"
        unique_id: people_home_count
        state: >
          {{ states.person
             | selectattr('state', 'eq', 'home')
             | list | length }}

      # Who is home
      - name: "Who Is Home"
        unique_id: who_is_home
        state: >
          {% set home = states.person
             | selectattr('state', 'eq', 'home')
             | map(attribute='attributes.friendly_name')
             | list %}
          {{ home | join(', ') if home else 'Nobody' }}

  # =====================================================
  # SYSTEM / ENTITY COUNTS
  # =====================================================

  - sensor:
      # Unavailable entities
      - name: "Unavailable Entities"
        unique_id: unavailable_entities
        state: >
          {{ states
             | selectattr('state', 'eq', 'unavailable')
             | list | length }}
        attributes:
          entities: >
            {{ states
               | selectattr('state', 'eq', 'unavailable')
               | map(attribute='entity_id')
               | list }}

      # Unknown entities
      - name: "Unknown Entities"
        unique_id: unknown_entities
        state: >
          {{ states
             | selectattr('state', 'eq', 'unknown')
             | list | length }}
