[
  {
    "id": "subflow_notification",
    "type": "subflow",
    "name": "Smart Notification",
    "info": "Smart notification router with quiet hours and priority handling.\n\n**Inputs:**\n- `msg.title` - Notification title\n- `msg.message` - Notification message\n- `msg.priority` - \"low\", \"normal\", \"high\", \"critical\"\n\n**Environment Variables:**\n- `NOTIFY_SERVICE` - Default notification service\n- `QUIET_START` - Quiet hours start (0-23)\n- `QUIET_END` - Quiet hours end (0-23)\n\n**Outputs:**\n1. Notification sent\n2. Blocked (quiet hours)\n\nGenerated by node-red@aurora-smart-home\nhttps://github.com/tonylofgren/aurora-smart-home",
    "category": "Aurora",
    "in": [
      {
        "x": 60,
        "y": 80,
        "wires": [
          { "id": "check_quiet" }
        ]
      }
    ],
    "out": [
      {
        "x": 500,
        "y": 60,
        "wires": [
          { "id": "send_notification", "port": 0 }
        ]
      },
      {
        "x": 500,
        "y": 140,
        "wires": [
          { "id": "check_quiet", "port": 1 }
        ]
      }
    ],
    "env": [
      {
        "name": "NOTIFY_SERVICE",
        "type": "str",
        "value": "notify.mobile_app_phone"
      },
      {
        "name": "QUIET_START",
        "type": "num",
        "value": "23"
      },
      {
        "name": "QUIET_END",
        "type": "num",
        "value": "7"
      }
    ],
    "color": "#3FADB5",
    "icon": "node-red/envelope.svg"
  },
  {
    "id": "check_quiet",
    "type": "function",
    "z": "subflow_notification",
    "name": "Check Quiet Hours",
    "func": "const hour = new Date().getHours();\nconst quietStart = parseInt(env.get(\"QUIET_START\"));\nconst quietEnd = parseInt(env.get(\"QUIET_END\"));\nconst priority = msg.priority || \"normal\";\n\n// Critical always goes through\nif (priority === \"critical\") {\n    node.status({fill:\"red\",shape:\"dot\",text:\"critical - sending\"});\n    return [msg, null];\n}\n\n// Check quiet hours\nlet isQuiet = false;\nif (quietStart > quietEnd) {\n    // Spans midnight (e.g., 23-7)\n    isQuiet = hour >= quietStart || hour < quietEnd;\n} else {\n    // Same day (e.g., 14-18)\n    isQuiet = hour >= quietStart && hour < quietEnd;\n}\n\nif (isQuiet && priority !== \"high\") {\n    node.status({fill:\"grey\",shape:\"ring\",text:\"quiet hours\"});\n    msg.blocked = true;\n    msg.reason = \"quiet_hours\";\n    return [null, msg];\n}\n\nnode.status({fill:\"green\",shape:\"dot\",text:\"sending\"});\nreturn [msg, null];",
    "outputs": 2,
    "timeout": "",
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 190,
    "y": 80,
    "wires": [
      ["send_notification"],
      []
    ],
    "outputLabels": ["Send", "Blocked"]
  },
  {
    "id": "send_notification",
    "type": "api-call-service",
    "z": "subflow_notification",
    "name": "Send Notification",
    "server": "",
    "version": 5,
    "debugEnabled": false,
    "domain": "",
    "service": "",
    "areaId": [],
    "deviceId": [],
    "entityId": [],
    "data": "",
    "dataType": "msg",
    "mergeContext": "",
    "mustacheAltTags": false,
    "outputProperties": [],
    "queue": "none",
    "x": 380,
    "y": 60,
    "wires": [
      []
    ]
  },
  {
    "id": "subflow_notification_instance",
    "type": "subflow:subflow_notification",
    "z": "",
    "name": "",
    "env": []
  },
  {
    "id": "example_flow",
    "type": "tab",
    "label": "Notification Example",
    "info": "Example usage of the Smart Notification subflow.\n\nGenerated by node-red@aurora-smart-home\nhttps://github.com/tonylofgren/aurora-smart-home"
  },
  {
    "id": "comment_example",
    "type": "comment",
    "z": "example_flow",
    "name": "âš™ï¸ CONFIGURATION REQUIRED",
    "info": "1. Edit the Smart Notification subflow\n2. Select your Home Assistant server in the service call node\n3. Update NOTIFY_SERVICE environment variable\n4. Adjust QUIET_START and QUIET_END hours",
    "x": 150,
    "y": 40,
    "wires": []
  },
  {
    "id": "example_inject_normal",
    "type": "inject",
    "z": "example_flow",
    "name": "Normal Notification",
    "props": [
      { "p": "title", "v": "Test Alert", "vt": "str" },
      { "p": "message", "v": "This is a normal priority test", "vt": "str" },
      { "p": "priority", "v": "normal", "vt": "str" }
    ],
    "repeat": "",
    "crontab": "",
    "once": false,
    "onceDelay": 0.1,
    "topic": "",
    "x": 160,
    "y": 120,
    "wires": [
      ["example_notify"]
    ]
  },
  {
    "id": "example_inject_critical",
    "type": "inject",
    "z": "example_flow",
    "name": "Critical Notification",
    "props": [
      { "p": "title", "v": "âš ï¸ CRITICAL ALERT", "vt": "str" },
      { "p": "message", "v": "This bypasses quiet hours!", "vt": "str" },
      { "p": "priority", "v": "critical", "vt": "str" }
    ],
    "repeat": "",
    "crontab": "",
    "once": false,
    "onceDelay": 0.1,
    "topic": "",
    "x": 160,
    "y": 180,
    "wires": [
      ["example_notify"]
    ]
  },
  {
    "id": "example_notify",
    "type": "subflow:subflow_notification",
    "z": "example_flow",
    "name": "Smart Notification",
    "env": [
      {
        "name": "NOTIFY_SERVICE",
        "value": "notify.mobile_app_phone",
        "type": "str"
      },
      {
        "name": "QUIET_START",
        "value": "23",
        "type": "num"
      },
      {
        "name": "QUIET_END",
        "value": "7",
        "type": "num"
      }
    ],
    "x": 400,
    "y": 150,
    "wires": [
      ["debug_sent"],
      ["debug_blocked"]
    ]
  },
  {
    "id": "debug_sent",
    "type": "debug",
    "z": "example_flow",
    "name": "Notification Sent",
    "active": true,
    "tosidebar": true,
    "console": false,
    "tostatus": true,
    "complete": "true",
    "targetType": "full",
    "statusVal": "\"Sent\"",
    "statusType": "jsonata",
    "x": 610,
    "y": 120,
    "wires": []
  },
  {
    "id": "debug_blocked",
    "type": "debug",
    "z": "example_flow",
    "name": "Notification Blocked",
    "active": true,
    "tosidebar": true,
    "console": false,
    "tostatus": true,
    "complete": "reason",
    "targetType": "msg",
    "statusVal": "reason",
    "statusType": "msg",
    "x": 620,
    "y": 180,
    "wires": []
  },
  {
    "id": "prepare_msg",
    "type": "function",
    "z": "example_flow",
    "name": "Prepare Message",
    "func": "// Convert msg to service call format\nconst service = env.get(\"NOTIFY_SERVICE\") || \"notify.persistent_notification\";\nconst [domain, svc] = service.split('.');\n\nmsg.payload = {\n    action: service,\n    data: {\n        title: msg.title || \"Notification\",\n        message: msg.message || msg.payload,\n        data: {\n            priority: msg.priority === \"critical\" ? \"high\" : \"normal\"\n        }\n    }\n};\n\nreturn msg;",
    "outputs": 1,
    "timeout": "",
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 280,
    "y": 260,
    "wires": [
      []
    ],
    "info": "This function shows how to prepare the message format.\nInclude this in your subflow or before calling the subflow."
  },
  {
    "id": "comment_usage",
    "type": "comment",
    "z": "example_flow",
    "name": "ðŸ“ Usage Instructions",
    "info": "## Smart Notification Subflow\n\n### Input Message Format\n\n```javascript\nmsg = {\n    title: \"Alert Title\",\n    message: \"Alert message content\",\n    priority: \"normal\"  // low, normal, high, critical\n};\n```\n\n### Priority Levels\n\n| Priority | Behavior |\n|----------|----------|\n| low | Blocked during quiet hours |\n| normal | Blocked during quiet hours |\n| high | Allowed during quiet hours |\n| critical | Always allowed, marked urgent |\n\n### Environment Variables\n\n- `NOTIFY_SERVICE`: The HA notify service (e.g., notify.mobile_app_phone)\n- `QUIET_START`: Hour when quiet period starts (0-23)\n- `QUIET_END`: Hour when quiet period ends (0-23)\n\n### Outputs\n\n1. **Output 1**: Notification was sent\n2. **Output 2**: Notification was blocked (quiet hours)\n\n### Customization\n\nEdit the subflow to:\n- Add additional notification services\n- Implement notification batching\n- Add logging\n- Support different targets based on priority",
    "x": 150,
    "y": 300,
    "wires": []
  }
]
